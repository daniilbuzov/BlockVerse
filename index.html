<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BlockVerse</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet">
<style>
:root{--red:#FF3B3B;--orange:#FF7A00;--yellow:#FFD600;--green:#00C853;--blue:#0066FF;--purple:#9B00FF;--dark:#0D0F1A;--dark2:#13151F;--dark3:#1C1F2E;--card:#222538;--border:#2E3250;--text:#E8EAFF;--muted:#7B7FA0;--sidebar:#16192A;}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Nunito',sans-serif;background:var(--dark);color:var(--text);}
.screen{position:fixed;inset:0;display:none;flex-direction:column;}
.screen.active{display:flex;}
#menuScreen{flex-direction:row;}
.menu-sidebar{width:68px;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;padding:12px 0;gap:5px;flex-shrink:0;}
.sb-logo{font-family:'Fredoka One',cursive;font-size:22px;color:var(--red);width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:rgba(255,59,59,.15);border-radius:12px;margin-bottom:8px;}
.sb-btn{width:44px;height:44px;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:2px;transition:.15s;border:1.5px solid transparent;}
.sb-btn:hover{background:rgba(255,255,255,.06);border-color:var(--border);}
.sb-btn.active{background:rgba(0,102,255,.18);border-color:var(--blue);}
.sb-icon{font-size:20px;line-height:1;}
.sb-label{font-size:8px;color:var(--muted);font-weight:700;letter-spacing:.3px;text-transform:uppercase;}
.sb-btn.active .sb-label{color:var(--blue);}
.sb-sep{width:36px;height:1px;background:var(--border);margin:3px 0;}
.sb-bottom{margin-top:auto;}
.av-sb{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--red),var(--orange));display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;border:2px solid var(--border);transition:.15s;}
.av-sb:hover{border-color:var(--red);}
.menu-main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.menu-topbar{height:52px;background:var(--dark2);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 18px;gap:12px;flex-shrink:0;}
.topbar-title{font-family:'Fredoka One',cursive;font-size:20px;color:var(--text);}
.search-wrap{flex:1;max-width:380px;background:var(--dark3);border:1px solid var(--border);border-radius:10px;display:flex;align-items:center;padding:0 11px;gap:7px;}
.search-wrap input{flex:1;background:none;border:none;color:var(--text);font-family:'Nunito',sans-serif;font-size:13px;outline:none;padding:7px 0;}
.search-wrap input::placeholder{color:var(--muted);}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:10px;}
.coins-badge{display:flex;align-items:center;gap:6px;background:var(--dark3);padding:5px 12px;border-radius:20px;border:1px solid rgba(255,214,0,.2);}
.coins-badge span{font-weight:800;font-size:13px;color:var(--yellow);}
.online-badge{display:flex;align-items:center;gap:5px;font-size:12px;color:var(--muted);}
.dot{width:7px;height:7px;border-radius:50%;}
.dot.green{background:var(--green);box-shadow:0 0 6px var(--green);animation:blink 2s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.3;}}
.content-page{flex:1;overflow-y:auto;display:none;padding:18px 22px;}
.content-page.active{display:block;}
.content-page::-webkit-scrollbar{width:4px;}
.content-page::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px;}
.section-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.section-hdr h2{font-family:'Fredoka One',cursive;font-size:17px;}
.see-all{font-size:11px;color:var(--blue);cursor:pointer;font-weight:700;}
.games-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:13px;margin-bottom:26px;}
.game-card{background:var(--card);border-radius:13px;overflow:hidden;cursor:pointer;transition:.18s;border:2px solid transparent;}
.game-card:hover{transform:translateY(-3px);border-color:rgba(255,255,255,.1);box-shadow:0 8px 22px rgba(0,0,0,.45);}
.gc-thumb{height:105px;display:flex;align-items:center;justify-content:center;font-size:44px;position:relative;}
.gc-live{position:absolute;top:7px;right:7px;background:var(--red);color:#fff;font-size:9px;font-weight:900;padding:2px 6px;border-radius:99px;}
.gc-body{padding:8px 10px 11px;}
.gc-title{font-weight:800;font-size:12px;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.gc-meta{font-size:10px;color:var(--muted);display:flex;align-items:center;gap:5px;}
.gc-players{color:var(--green);font-weight:700;}
.genre-tag{background:var(--dark3);padding:2px 6px;border-radius:99px;}
.cat-row{display:flex;gap:7px;margin-bottom:16px;flex-wrap:wrap;}
.cat-chip{padding:5px 13px;border-radius:99px;border:1.5px solid var(--border);background:var(--dark3);font-size:11px;font-weight:700;cursor:pointer;transition:.15s;color:var(--muted);}
.cat-chip:hover,.cat-chip.active{background:var(--blue);border-color:var(--blue);color:#fff;}
.friends-pg-inner{display:flex;flex-direction:column;height:100%;}
.friends-topbar{padding:16px 20px 12px;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;gap:12px;}
.friends-topbar h2{font-family:'Fredoka One',cursive;font-size:20px;}
.friends-body{padding:14px 18px;display:grid;grid-template-columns:repeat(auto-fill,minmax(255px,1fr));gap:10px;overflow-y:auto;flex:1;}
.friend-card{background:var(--card);border-radius:13px;padding:12px;display:flex;gap:11px;align-items:center;border:2px solid var(--border);cursor:pointer;transition:.15s;}
.friend-card:hover{border-color:var(--blue);box-shadow:0 4px 14px rgba(0,102,255,.18);}
.friend-av{width:44px;height:44px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;}
.friend-info{flex:1;min-width:0;}
.fi-name{font-weight:800;font-size:13px;margin-bottom:2px;}
.fi-status{font-size:11px;display:flex;align-items:center;gap:4px;color:var(--muted);}
.sdot{width:6px;height:6px;border-radius:50%;}
.s-online{background:var(--green);box-shadow:0 0 5px var(--green);}
.s-ingame{background:var(--orange);box-shadow:0 0 5px var(--orange);}
.s-offline{background:var(--muted);}
.join-btn{background:var(--blue);border:none;border-radius:8px;padding:5px 11px;color:#fff;font-weight:800;font-size:11px;cursor:pointer;transition:.15s;flex-shrink:0;}
.join-btn:hover{background:#3380ff;}
.join-btn:disabled{background:var(--dark3);color:var(--muted);cursor:default;}
/* GAME */
#gameScreen{z-index:1000;background:#000;}
#gameCanvas{position:absolute;inset:0;width:100%;height:100%;display:block;}
.g-hud{position:absolute;top:0;left:0;right:0;height:46px;background:rgba(13,15,26,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 12px;gap:9px;z-index:10;}
.g-logo{font-family:'Fredoka One',cursive;font-size:17px;color:var(--red);}
.g-game{font-weight:800;font-size:13px;background:var(--dark3);padding:4px 11px;border-radius:7px;border:1px solid var(--border);}
.g-right{margin-left:auto;display:flex;gap:7px;align-items:center;}
.g-btn{background:var(--dark3);border:1px solid var(--border);border-radius:7px;padding:4px 10px;color:var(--text);font-family:'Nunito',sans-serif;font-size:11px;font-weight:700;cursor:pointer;transition:.15s;}
.g-btn:hover{background:var(--card);border-color:var(--blue);}
.g-btn.danger{border-color:rgba(255,59,59,.4);color:var(--red);}
.g-btn.danger:hover{background:rgba(255,59,59,.12);}
.g-stats{position:absolute;top:54px;left:11px;background:rgba(13,15,26,.78);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:9px;padding:7px 12px;font-size:11px;z-index:10;line-height:1.7;}
.g-stats span{color:var(--muted);}
.g-stats b{color:var(--text);}
.server-panel{position:absolute;top:0;right:0;width:255px;height:100%;background:rgba(13,15,26,.95);backdrop-filter:blur(14px);border-left:1px solid var(--border);display:flex;flex-direction:column;z-index:15;transform:translateX(100%);transition:transform .28s cubic-bezier(.4,0,.2,1);}
.server-panel.open{transform:translateX(0);}
.sp-hdr{padding:11px 13px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;}
.sp-hdr h3{font-family:'Fredoka One',cursive;font-size:15px;flex:1;}
.sp-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:17px;transition:.15s;}
.sp-close:hover{color:var(--text);}
.server-list{flex:1;overflow-y:auto;padding:7px;}
.server-list::-webkit-scrollbar{width:3px;}
.server-list::-webkit-scrollbar-thumb{background:var(--border);}
.sv-item{background:var(--dark3);border-radius:9px;padding:10px 11px;margin-bottom:5px;border:1.5px solid var(--border);cursor:pointer;transition:.15s;}
.sv-item:hover{border-color:var(--blue);background:rgba(0,102,255,.07);}
.sv-item.me{border-color:var(--green);background:rgba(0,200,83,.05);}
.sv-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;}
.sv-name{font-weight:800;font-size:11px;}
.sv-bar{height:4px;background:var(--border);border-radius:99px;overflow:hidden;margin-bottom:4px;}
.sv-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--blue),var(--purple));}
.sv-meta{display:flex;justify-content:space-between;font-size:10px;color:var(--muted);}
.sv-join{background:var(--blue);border:none;border-radius:6px;padding:4px 10px;color:#fff;font-weight:800;font-size:10px;cursor:pointer;transition:.15s;margin-top:5px;width:100%;}
.sv-join:hover{background:#3380ff;}
.players-hud{position:absolute;top:54px;right:11px;background:rgba(13,15,26,.78);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:9px;padding:7px 11px;font-size:10px;z-index:10;min-width:130px;}
.pl-title{font-weight:800;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.4px;}
.pl-item{display:flex;align-items:center;gap:5px;margin-bottom:2px;}
.pl-dot{width:5px;height:5px;border-radius:50%;}
.pl-name{font-weight:700;}
.chat-wrap{position:absolute;bottom:10px;left:10px;width:265px;z-index:10;}
.chat-log{background:rgba(13,15,26,.72);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:10px 10px 0 0;padding:7px;max-height:145px;overflow-y:auto;display:flex;flex-direction:column;gap:2px;}
.chat-log::-webkit-scrollbar{width:3px;}
.chat-log::-webkit-scrollbar-thumb{background:var(--border);}
.chat-msg{font-size:11px;line-height:1.4;}
.cm-name{font-weight:900;}
.chat-row{display:flex;}
.chat-input{flex:1;background:rgba(13,15,26,.9);border:1px solid var(--border);border-top:none;border-radius:0 0 0 10px;padding:6px 9px;color:var(--text);font-family:'Nunito',sans-serif;font-size:11px;outline:none;}
.chat-input:focus{border-color:var(--blue);}
.chat-send{background:var(--blue);border:none;border-radius:0 0 10px 0;padding:0 12px;color:#fff;cursor:pointer;font-weight:800;font-size:12px;}
.ctrl-hint{position:absolute;bottom:10px;right:10px;background:rgba(13,15,26,.72);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:9px;padding:7px 11px;font-size:11px;color:var(--muted);line-height:1.9;z-index:10;}
.ctrl-hint b{color:var(--text);}
/* AVATAR */
#avatarScreen{flex-direction:column;}
.av-main{flex:1;display:flex;overflow:hidden;}
.av-left{width:300px;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;}
.av-preview{height:250px;background:radial-gradient(ellipse at center,#1C2040 0%,#0D0F1A 100%);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:7px;border-bottom:1px solid var(--border);}
.av-big{font-size:86px;animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}}
.av-uname{font-size:12px;font-weight:800;color:var(--muted);}
.av-tabs{display:flex;border-bottom:1px solid var(--border);}
.av-tab{flex:1;padding:9px;text-align:center;font-size:10px;font-weight:800;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:.15s;text-transform:uppercase;}
.av-tab.active{color:var(--blue);border-color:var(--blue);}
.av-grid{flex:1;overflow-y:auto;padding:9px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;align-content:start;}
.av-item{background:var(--dark3);border-radius:9px;padding:9px 5px;text-align:center;cursor:pointer;border:2px solid transparent;transition:.15s;}
.av-item:hover{border-color:var(--blue);}
.av-item.sel{border-color:var(--red);background:rgba(255,59,59,.07);}
.av-item-ico{font-size:24px;margin-bottom:3px;}
.av-item-nm{font-size:9px;color:var(--muted);}
.av-right{flex:1;overflow-y:auto;padding:18px 22px;display:flex;flex-direction:column;gap:18px;}
.av-section h3{font-family:'Fredoka One',cursive;font-size:15px;margin-bottom:9px;}
.color-row{display:flex;flex-wrap:wrap;gap:6px;}
.cswatch{width:34px;height:34px;border-radius:8px;cursor:pointer;border:3px solid transparent;transition:.15s;}
.cswatch:hover{transform:scale(1.12);}
.cswatch.sel{border-color:#fff;box-shadow:0 0 0 2px var(--blue);}
.av-input{width:100%;background:var(--dark3);border:1.5px solid var(--border);border-radius:9px;padding:7px 12px;color:var(--text);font-family:'Nunito',sans-serif;font-size:13px;outline:none;}
.av-input:focus{border-color:var(--blue);}
.big-btn{width:100%;padding:11px;border:none;border-radius:11px;color:#fff;font-family:'Nunito',sans-serif;font-weight:800;font-size:14px;cursor:pointer;transition:.18s;}
.big-btn:hover{transform:translateY(-2px);}
.btn-save{background:linear-gradient(135deg,var(--blue),var(--purple));}
.btn-back{background:var(--dark3);color:var(--text);border:1.5px solid var(--border);}
.btn-back:hover{border-color:var(--red);color:var(--red);}
/* STUDIO */
#studioScreen{flex-direction:column;}
.st-main{flex:1;display:flex;overflow:hidden;}
.st-left{width:185px;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;}
.st-left h3{padding:13px 15px;font-family:'Fredoka One',cursive;font-size:14px;border-bottom:1px solid var(--border);}
.tool-list{padding:9px;flex:1;}
.tool-btn{width:100%;padding:8px 11px;border-radius:8px;background:transparent;border:1.5px solid transparent;color:var(--muted);cursor:pointer;font-weight:700;font-size:11px;display:flex;align-items:center;gap:7px;transition:.15s;margin-bottom:3px;text-align:left;}
.tool-btn:hover{background:var(--dark3);color:var(--text);}
.tool-btn.active{background:rgba(0,102,255,.15);border-color:var(--blue);color:var(--blue);}
.tool-div{height:1px;background:var(--border);margin:6px 0;}
.st-canvas-area{flex:1;position:relative;background:#0B0C18;overflow:hidden;}
#studioCanvas{position:absolute;inset:0;display:block;}
.st-hint{position:absolute;top:9px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.65);border:1px solid var(--border);border-radius:7px;padding:4px 12px;font-size:11px;color:var(--muted);pointer-events:none;white-space:nowrap;}
.st-right{width:185px;background:var(--sidebar);border-left:1px solid var(--border);display:flex;flex-direction:column;}
.st-right h3{padding:13px 15px;font-family:'Fredoka One',cursive;font-size:14px;border-bottom:1px solid var(--border);}
.prop-area{flex:1;overflow-y:auto;padding:9px;}
.prop-label{font-size:10px;color:var(--muted);font-weight:800;letter-spacing:.4px;text-transform:uppercase;margin-bottom:4px;}
.prop-group{margin-bottom:12px;}
.prop-input{width:100%;background:var(--dark3);border:1.5px solid var(--border);border-radius:7px;padding:5px 9px;color:var(--text);font-family:'Nunito',sans-serif;font-size:11px;outline:none;}
.prop-input:focus{border-color:var(--blue);}
.mini-swatch{width:24px;height:24px;border-radius:5px;cursor:pointer;border:2px solid transparent;transition:.15s;display:inline-block;}
.mini-swatch:hover{transform:scale(1.15);}
.mini-swatch.sel{border-color:#fff;box-shadow:0 0 0 1.5px var(--blue);}
.st-footer{padding:9px;}
.publish-btn{width:100%;padding:10px;background:linear-gradient(135deg,var(--green),#00A896);border:none;border-radius:10px;color:#fff;font-weight:800;font-size:13px;cursor:pointer;transition:.18s;}
.publish-btn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(0,200,83,.3);}
.placed-cnt{text-align:center;font-size:10px;color:var(--muted);margin-top:5px;}
/* MODAL */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);z-index:9999;display:none;align-items:center;justify-content:center;}
.modal-bg.open{display:flex;}
.modal{background:var(--dark2);border:1px solid var(--border);border-radius:17px;padding:24px;width:330px;}
.modal h3{font-family:'Fredoka One',cursive;font-size:19px;margin-bottom:14px;}
.modal input,.modal textarea,.modal select{width:100%;background:var(--dark3);border:1.5px solid var(--border);border-radius:8px;padding:7px 11px;color:var(--text);font-family:'Nunito',sans-serif;font-size:12px;outline:none;margin-bottom:8px;}
.modal textarea{resize:vertical;min-height:65px;}
.modal-btns{display:flex;gap:7px;}
.modal-btns button{flex:1;padding:9px;border:none;border-radius:9px;font-weight:800;font-size:12px;cursor:pointer;transition:.15s;}
.mbtn-cancel{background:var(--dark3);color:var(--text);}
.mbtn-ok{background:linear-gradient(135deg,var(--green),#00A896);color:#fff;}
/* TOASTS */
.toasts{position:fixed;top:12px;right:12px;z-index:99999;display:flex;flex-direction:column;gap:6px;pointer-events:none;}
.toast{background:var(--card);border:1.5px solid var(--border);border-radius:10px;padding:8px 14px;font-size:12px;font-weight:700;animation:tIn .25s ease;max-width:250px;}
.toast.ok{border-color:var(--green);color:var(--green);}
.toast.err{border-color:var(--red);color:var(--red);}
.toast.info{border-color:var(--blue);color:var(--blue);}
@keyframes tIn{from{transform:translateX(70px);opacity:0;}to{transform:translateX(0);opacity:1;}}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px;}
</style>
</head>
<body>
<div class="toasts" id="toasts"></div>
<div class="modal-bg" id="publishModal">
  <div class="modal">
    <h3>üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∏–≥—Ä—É</h3>
    <input id="pubTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ...">
    <textarea id="pubDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ...">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</textarea>
    <select id="pubGenre"><option>–ü–ª–∞—Ç—Ñ–æ—Ä–º–µ—Ä</option><option>–û–±—Å—Ç—Ä–µ–ª–∫–∏</option><option>–°–∏–º—É–ª—è—Ç–æ—Ä</option><option>RPG</option><option>–ì–æ–Ω–∫–∏</option><option>–ú–∏–Ω–∏-–∏–≥—Ä–∞</option></select>
    <div class="modal-btns"><button class="mbtn-cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button><button class="mbtn-ok" onclick="doPublish()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å!</button></div>
  </div>
</div>

<!-- MENU -->
<div class="screen active" id="menuScreen">
  <div class="menu-sidebar">
    <div class="sb-logo">B</div>
    <div class="sb-btn active" id="sbHome" onclick="showPage('home',this)"><div class="sb-icon">üè†</div><div class="sb-label">–ì–ª–∞–≤–Ω–∞—è</div></div>
    <div class="sb-btn" id="sbGames" onclick="showPage('games',this)"><div class="sb-icon">üéÆ</div><div class="sb-label">–ò–≥—Ä—ã</div></div>
    <div class="sb-btn" id="sbFriends" onclick="showPage('friends',this)"><div class="sb-icon">üë•</div><div class="sb-label">–î—Ä—É–∑—å—è</div></div>
    <div class="sb-sep"></div>
    <div class="sb-btn" onclick="openStudio()"><div class="sb-icon">üõ†</div><div class="sb-label">–°—Ç—É–¥–∏—è</div></div>
    <div class="sb-btn sb-bottom" onclick="openAvatar()"><div class="sb-icon" id="navAvaIco">üòé</div><div class="sb-label">–ü–µ—Ä—Å–æ–Ω–∞–∂</div></div>
  </div>
  <div class="menu-main">
    <div class="menu-topbar">
      <div class="topbar-title" id="topbarTitle">–ì–ª–∞–≤–Ω–∞—è</div>
      <div class="search-wrap"><span>üîç</span><input placeholder="–ù–∞–π—Ç–∏ –∏–≥—Ä—ã..." oninput="globalSearch(this.value)"></div>
      <div class="topbar-right">
        <div class="online-badge"><div class="dot green"></div><span id="onlineCnt">12,847</span> –æ–Ω–ª–∞–π–Ω</div>
        <div class="coins-badge">ü™ô <span id="coinsVal">1,250</span></div>
        <div class="av-sb" id="topAvatar" onclick="openAvatar()">üòé</div>
      </div>
    </div>
    <div class="content-page active" id="pageHome">
      <div class="section-hdr" style="margin-top:2px;"><h2>üî• –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</h2><span class="see-all" onclick="showPage('games',document.getElementById('sbGames'))">–í—Å–µ ‚Üí</span></div>
      <div class="games-row" id="featuredRow"></div>
      <div class="section-hdr"><h2>üÜï –ù–æ–≤–∏–Ω–∫–∏</h2></div>
      <div class="games-row" id="newRow"></div>
      <div class="section-hdr"><h2>üë• –ò–≥—Ä–∞—é—Ç –¥—Ä—É–∑—å—è</h2></div>
      <div class="games-row" id="friendsRow"></div>
    </div>
    <div class="content-page" id="pageGames">
      <div class="cat-row" id="catRow"></div>
      <div class="section-hdr"><h2 id="gamesTitle">–í—Å–µ –∏–≥—Ä—ã</h2></div>
      <div class="games-row" id="allGamesRow"></div>
    </div>
    <div class="content-page" id="pageFriends">
      <div class="friends-pg-inner">
        <div class="friends-topbar"><h2>üë• –î—Ä—É–∑—å—è</h2><div style="color:var(--muted);font-size:13px;margin-left:auto;"><span style="color:var(--green)">‚óè</span> 5 –æ–Ω–ª–∞–π–Ω</div></div>
        <div class="friends-body" id="friendsBody"></div>
      </div>
    </div>
  </div>
</div>

<!-- AVATAR -->
<div class="screen" id="avatarScreen">
  <div class="menu-topbar" style="flex-shrink:0;">
    <button class="big-btn btn-back" style="width:auto;padding:5px 13px;font-size:12px;" onclick="closeAvatar()">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="topbar-title" style="margin-left:8px;">üë§ –ü–µ—Ä—Å–æ–Ω–∞–∂</div>
  </div>
  <div class="av-main">
    <div class="av-left">
      <div class="av-preview"><div class="av-big" id="avBig">üòé</div><div class="av-uname" id="avUname">CoolPlayer</div></div>
      <div class="av-tabs">
        <div class="av-tab active" onclick="avTab(this,'head')">–ì–æ–ª–æ–≤–∞</div>
        <div class="av-tab" onclick="avTab(this,'body')">–¢–µ–ª–æ</div>
        <div class="av-tab" onclick="avTab(this,'acc')">–ê–∫—Å.</div>
      </div>
      <div class="av-grid" id="avGrid"></div>
    </div>
    <div class="av-right">
      <div class="av-section"><h3>üé® –¶–≤–µ—Ç –∫–æ–∂–∏</h3><div class="color-row" id="skinRow"></div></div>
      <div class="av-section"><h3>üëï –¶–≤–µ—Ç –æ–¥–µ–∂–¥—ã</h3><div class="color-row" id="clothRow"></div></div>
      <div class="av-section"><h3>‚úèÔ∏è –ò–º—è</h3><input class="av-input" id="avNameInp" value="CoolPlayer" oninput="avNameChange(this.value)"></div>
      <button class="big-btn btn-save" onclick="saveAvatar()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- STUDIO -->
<div class="screen" id="studioScreen">
  <div class="menu-topbar" style="flex-shrink:0;">
    <button class="big-btn btn-back" style="width:auto;padding:5px 13px;font-size:12px;" onclick="closeStudio()">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="topbar-title" style="margin-left:8px;">üõ† –°—Ç—É–¥–∏—è</div>
    <div style="margin-left:auto;font-size:10px;color:var(--muted);">–õ–ö–ú ‚Äî —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å ¬∑ –ü–ö–ú ‚Äî —É–¥–∞–ª–∏—Ç—å ¬∑ –ö–æ–ª—ë—Å–æ ‚Äî –≤—ã—Å–æ—Ç–∞</div>
  </div>
  <div class="st-main">
    <div class="st-left">
      <h3>üß∞ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h3>
      <div class="tool-list">
        <button class="tool-btn active" onclick="selTool(this,'cube')">üì¶ –ë–ª–æ–∫</button>
        <button class="tool-btn" onclick="selTool(this,'sphere')">üî¥ –°—Ñ–µ—Ä–∞</button>
        <button class="tool-btn" onclick="selTool(this,'cyl')">üü§ –¶–∏–ª–∏–Ω–¥—Ä</button>
        <button class="tool-btn" onclick="selTool(this,'spawn')">‚≠ê –°–ø–∞–≤–Ω</button>
        <div class="tool-div"></div>
        <button class="tool-btn" style="color:#FF6B6B;" onclick="selTool(this,'delete')">üóë –£–¥–∞–ª–∏—Ç—å</button>
        <button class="tool-btn" style="color:#FF6B6B;" onclick="clearAll()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
      <div style="padding:7px 10px;border-top:1px solid var(--border);"><div class="placed-cnt" id="placedCnt">–û–±—ä–µ–∫—Ç–æ–≤: 0</div></div>
    </div>
    <div class="st-canvas-area" id="stCanvasArea">
      <canvas id="studioCanvas"></canvas>
      <div class="st-hint">WASD / –°—Ç—Ä–µ–ª–∫–∏ ‚Äî –∫–∞–º–µ—Ä–∞ ¬∑ –ö–æ–ª–µ—Å–æ ‚Äî –≤—ã—Å–æ—Ç–∞</div>
    </div>
    <div class="st-right">
      <h3>‚öôÔ∏è –°–≤–æ–π—Å—Ç–≤–∞</h3>
      <div class="prop-area">
        <div class="prop-group"><div class="prop-label">–¶–≤–µ—Ç –±–ª–æ–∫–∞</div><div style="display:flex;flex-wrap:wrap;gap:4px;" id="stColors"></div></div>
        <div class="prop-group"><div class="prop-label">–ù–∞–∑–≤–∞–Ω–∏–µ</div><input class="prop-input" id="stName" value="–ú–æ—è –∏–≥—Ä–∞"></div>
        <div class="prop-group"><div class="prop-label">–û–ø–∏—Å–∞–Ω–∏–µ</div><input class="prop-input" id="stDesc" value="–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!"></div>
      </div>
      <div class="st-footer"><button class="publish-btn" onclick="showPublish()">üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button></div>
    </div>
  </div>
</div>

<!-- GAME -->
<div class="screen" id="gameScreen">
  <canvas id="gameCanvas"></canvas>
  <div class="g-hud">
    <div class="g-logo">‚¨õ BV</div>
    <div class="g-game" id="hudTitle">–ú–∏—Ä –ë–ª–æ–∫–æ–≤</div>
    <div class="g-right">
      <button class="g-btn" onclick="toggleSP()">üåê –°–µ—Ä–≤–µ—Ä—ã</button>
      <button class="g-btn danger" onclick="leaveGame()">‚¨Ö –í—ã–π—Ç–∏</button>
    </div>
  </div>
  <div class="g-stats">
    <div><span>X:</span><b id="px">0</b>&nbsp;<span>Y:</span><b id="py">0</b>&nbsp;<span>Z:</span><b id="pz">0</b></div>
    <div><span>–ü–∏–Ω–≥:</span><b id="pingVal" style="color:var(--green)">28ms</b></div>
    <div><span>FPS:</span><b id="fpsVal" style="color:var(--yellow)">60</b></div>
  </div>
  <div class="players-hud" id="playersHud">
    <div class="pl-title">–ò–≥—Ä–æ–∫–∏</div>
    <div id="playersList"></div>
  </div>
  <div class="server-panel" id="serverPanel">
    <div class="sp-hdr"><h3>üåê –°–µ—Ä–≤–µ—Ä—ã</h3><button class="sp-close" onclick="toggleSP()">‚úï</button></div>
    <div class="server-list" id="serverList"></div>
  </div>
  <div class="chat-wrap">
    <div class="chat-log" id="chatLog"></div>
    <div class="chat-row">
      <input class="chat-input" id="chatInp" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å..." onkeydown="if(event.key==='Enter')sendChat()">
      <button class="chat-send" onclick="sendChat()">‚ñ∂</button>
    </div>
  </div>
  <div class="ctrl-hint"><b>WASD</b> ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ<br><b>SPACE</b> ‚Äî –ø—Ä—ã–∂–æ–∫<br><b>–ú—ã—à—å</b> ‚Äî –∫–∞–º–µ—Ä–∞ (–∫–ª–∏–∫)<br><b>ESC</b> ‚Äî –≤—ã—Ö–æ–¥</div>
</div>

<script>
const GD=[{id:'bw',title:'–ë–ª–æ—á–Ω—ã–π –ú–∏—Ä',thumb:'üåç',clr:'#1565C0',players:3420,genre:'–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è'},{id:'obby',title:'Obstacle Course',thumb:'üèÉ',clr:'#E65100',players:8750,genre:'–ü–ª–∞—Ç—Ñ–æ—Ä–º–µ—Ä'},{id:'rpg',title:'–õ–µ–≥–µ–Ω–¥—ã RPG',thumb:'‚öîÔ∏è',clr:'#4A148C',players:2100,genre:'RPG'},{id:'tyc',title:'–¢–∞–π–∫—É–Ω',thumb:'üèóÔ∏è',clr:'#33691E',players:5600,genre:'–°–∏–º—É–ª—è—Ç–æ—Ä'},{id:'race',title:'–ì–æ–Ω–∫–∏',thumb:'üèéÔ∏è',clr:'#B71C1C',players:4200,genre:'–ì–æ–Ω–∫–∏'},{id:'hide',title:'–ü—Ä—è—Ç–∫–∏',thumb:'üôà',clr:'#006064',players:9100,genre:'–ú–∏–Ω–∏-–∏–≥—Ä–∞'},{id:'pvp',title:'–ú–µ—á–Ω–∏–∫–∏',thumb:'üó°Ô∏è',clr:'#37474F',players:3800,genre:'PvP'},{id:'twr',title:'–ë–∞—à–Ω—è –•–∞–æ—Å–∞',thumb:'üè∞',clr:'#6A1B9A',players:1900,genre:'–ü–ª–∞—Ç—Ñ–æ—Ä–º–µ—Ä'}];
const GENRES=['–í—Å–µ','–ü–ª–∞—Ç—Ñ–æ—Ä–º–µ—Ä','PvP','–°–∏–º—É–ª—è—Ç–æ—Ä','RPG','–ì–æ–Ω–∫–∏','–ú–∏–Ω–∏-–∏–≥—Ä–∞','–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è'];
const FD=[{name:'Alex_Pro',ico:'üòÑ',bg:'#1565C0',status:'online',game:null},{name:'PixelQueen',ico:'üë∏',bg:'#880E4F',status:'ingame',game:'–ü—Ä—è—Ç–∫–∏'},{name:'NightWolf',ico:'üê∫',bg:'#37474F',status:'online',game:null},{name:'StarBuilder',ico:'‚≠ê',bg:'#F57F17',status:'ingame',game:'–¢–∞–π–∫—É–Ω'},{name:'xXShadowXx',ico:'ü¶π',bg:'#B71C1C',status:'offline',game:null},{name:'CuteKitty',ico:'üê±',bg:'#E91E63',status:'online',game:null},{name:'DragonSlayer',ico:'üêâ',bg:'#2E7D32',status:'offline',game:null},{name:'TechGuru',ico:'ü§ñ',bg:'#0097A7',status:'ingame',game:'RPG'}];
const CHAT_N=['Alex_Pro','PixelQueen','NightWolf','StarBuilder','CuteKitty','TechGuru'];
const CHAT_C=['#FF6B6B','#B388FF','#4FC3F7','#FFD54F','#80CBC4','#AED581'];
const CHAT_M=['–ü—Ä–∏–≤–µ—Ç!','–∫—Ç–æ —É–º–µ–µ—Ç —Å—Ç—Ä–æ–∏—Ç—å?','GG!','–∫–∞–∫ –ø—Ä–æ–π—Ç–∏?','—ç—Ç–æ –∫—Ä—É—Ç–æ!','—Å—Ç–∞–≤—å—Ç–µ –ª–∞–π–∫–∏','–ª–æ–ª)','gg wp','üî•üî•','OMG!!!','—Å–ª–µ–¥—É–π—Ç–µ –∑–∞ –º–Ω–æ–π'];
const SKIN_C=['#FFDAB9','#F4A460','#DEB887','#D2691E','#8B4513','#4A2311','#FFE4C4','#C68642'];
const CLOTH_C=['#FF3B3B','#0066FF','#00C853','#FFD600','#9B00FF','#FF7A00','#00BCD4','#455A64'];
const ST_C=['#FF3B3B','#0066FF','#00C853','#FFD600','#9B00FF','#FF7A00','#FFFFFF','#607D8B','#8D6E63','#00BCD4'];
const AV_H=[{i:'üòä',n:'–ö–ª–∞—Å—Å–∏–∫'},{i:'üòé',n:'–ö—Ä—É—Ç–æ–π'},{i:'ü§ñ',n:'–†–æ–±–æ—Ç'},{i:'üëæ',n:'–ü—Ä–∏—à–µ–ª–µ—Ü'},{i:'üéÉ',n:'–¢—ã–∫–≤–∞'},{i:'ü¶ä',n:'–õ–∏—Å–∞'}];
const AV_B=[{i:'üëï',n:'–§—É—Ç–±–æ–ª–∫–∞'},{i:'ü•ã',n:'–ö–∏–º–æ–Ω–æ'},{i:'üéΩ',n:'–ú–∞–π–∫–∞'},{i:'üß•',n:'–ü–∞–ª—å—Ç–æ'},{i:'üëî',n:'–ü–∏–¥–∂–∞–∫'},{i:'ü¶∫',n:'–ñ–∏–ª–µ—Ç'}];
const AV_A=[{i:'üé©',n:'–¶–∏–ª–∏–Ω–¥—Ä'},{i:'üëë',n:'–ö–æ—Ä–æ–Ω–∞'},{i:'ü™ñ',n:'–®–ª–µ–º'},{i:'üï∂Ô∏è',n:'–û—á–∫–∏'},{i:'üé≠',n:'–ú–∞—Å–∫–∞'},{i:'üéÆ',n:'–ì–µ–π–º–ø–∞–¥'}];
const SRVS=[{id:'eu1',name:'–°–µ—Ä–≤–µ—Ä EU-1',ping:28,players:14,max:20,me:false},{id:'eu2',name:'–°–µ—Ä–≤–µ—Ä EU-2',ping:35,players:8,max:20,me:true},{id:'ru1',name:'–°–µ—Ä–≤–µ—Ä RU-1',ping:18,players:19,max:20,me:false},{id:'ru2',name:'–°–µ—Ä–≤–µ—Ä RU-2',ping:22,players:5,max:20,me:false},{id:'us1',name:'–°–µ—Ä–≤–µ—Ä US-1',ping:110,players:11,max:20,me:false},{id:'prv',name:'–ü—Ä–∏–≤–∞—Ç–Ω—ã–π',ping:15,players:3,max:10,me:false}];
const S={coins:1250,ava:'üòé',skin:'#F4A460',cloth:'#0066FF',pname:'CoolPlayer',stColor:'#FF3B3B',stool:'cube',stObjs:[],stPlaced:0,published:[]};

function showPage(name,el){
  document.querySelectorAll('.content-page').forEach(p=>{p.classList.remove('active');});
  document.querySelectorAll('.sb-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page'+name.charAt(0).toUpperCase()+name.slice(1)).classList.add('active');
  if(el) el.classList.add('active');
  document.getElementById('topbarTitle').textContent={home:'–ì–ª–∞–≤–Ω–∞—è',games:'–ò–≥—Ä—ã',friends:'–î—Ä—É–∑—å—è'}[name]||'';
}
function gameCard(g){
  if(!g)return'';
  return`<div class="game-card" onclick="launchGame('${g.id}','${g.title}','${g.clr||'#1565C0'}')"><div class="gc-thumb" style="background:linear-gradient(135deg,${g.clr}44,${g.clr}aa)"><span>${g.thumb||'üéÆ'}</span>${g.players>5000?'<div class="gc-live">LIVE</div>':''}</div><div class="gc-body"><div class="gc-title">${g.title}</div><div class="gc-meta"><span class="genre-tag">${g.genre}</span><span class="gc-players">‚óè ${(g.players||0).toLocaleString('ru')}</span></div></div></div>`;
}
function buildHome(){
  const all=[...GD,...S.published];
  document.getElementById('featuredRow').innerHTML=all.slice(0,4).map(gameCard).join('');
  document.getElementById('newRow').innerHTML=[...S.published,...all].slice(-4).map(gameCard).join('');
  const pf=FD.filter(f=>f.status==='ingame').map(f=>all.find(g=>g.title===f.game)).filter(Boolean);
  document.getElementById('friendsRow').innerHTML=(pf.length?pf:all.slice(4,7)).map(gameCard).join('');
}
function buildGamesPage(){
  document.getElementById('catRow').innerHTML=GENRES.map((g,i)=>`<div class="cat-chip ${i===0?'active':''}" onclick="filterGenre(this,'${g}')">${g}</div>`).join('');
  renderAllGames([...GD,...S.published]);
}
function filterGenre(el,genre){
  document.querySelectorAll('.cat-chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');
  const all=[...GD,...S.published];renderAllGames(genre==='–í—Å–µ'?all:all.filter(g=>g.genre===genre));
  document.getElementById('gamesTitle').textContent=genre==='–í—Å–µ'?'–í—Å–µ –∏–≥—Ä—ã':genre;
}
function renderAllGames(list){document.getElementById('allGamesRow').innerHTML=list.length?list.map(gameCard).join(''):'<div style="color:var(--muted);grid-column:1/-1;padding:16px;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';}
function globalSearch(v){
  if(!v.trim()){buildHome();return;}
  const q=v.toLowerCase(),res=[...GD,...S.published].filter(g=>g.title.toLowerCase().includes(q)||g.genre.toLowerCase().includes(q));
  showPage('games',document.getElementById('sbGames'));document.getElementById('gamesTitle').textContent='–ü–æ–∏—Å–∫: "'+v+'"';renderAllGames(res);
}
function buildFriends(){
  document.getElementById('friendsBody').innerHTML=FD.map(f=>{
    const dc=f.status==='online'?'s-online':f.status==='ingame'?'s-ingame':'s-offline';
    const st=f.status==='online'?'–í —Å–µ—Ç–∏':f.status==='ingame'?'–ò–≥—Ä–∞–µ—Ç: '+f.game:'–ù–µ –≤ —Å–µ—Ç–∏';
    return`<div class="friend-card"><div class="friend-av" style="background:${f.bg}">${f.ico}</div><div class="friend-info"><div class="fi-name">${f.name}</div><div class="fi-status"><div class="sdot ${dc}"></div>${st}</div></div>${f.status==='ingame'?`<button class="join-btn" onclick="joinFriend('${f.name}','${f.game}')">–ó–∞–π—Ç–∏</button>`:`<button class="join-btn" disabled>${f.status==='online'?'–ü–æ–∑–≤–∞—Ç—å':'‚Äî'}</button>`}</div>`;
  }).join('');
}
function joinFriend(name,game){toast('üöÄ –ó–∞—Ö–æ–¥–∏–º –∫ '+name+'...','info');setTimeout(()=>launchGame('join',game,'#1565C0'),700);}
function openAvatar(){
  document.getElementById('menuScreen').classList.remove('active');document.getElementById('avatarScreen').classList.add('active');
  buildAvGrid('head');buildSwatches();document.getElementById('avBig').textContent=S.ava;document.getElementById('avUname').textContent=S.pname;document.getElementById('avNameInp').value=S.pname;
}
function closeAvatar(){document.getElementById('avatarScreen').classList.remove('active');document.getElementById('menuScreen').classList.add('active');}
function avTab(el,type){document.querySelectorAll('.av-tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');buildAvGrid(type);}
function buildAvGrid(type){
  const d=type==='head'?AV_H:type==='body'?AV_B:AV_A;
  document.getElementById('avGrid').innerHTML=d.map((it,i)=>`<div class="av-item ${i===0?'sel':''}" onclick="pickAvItem(this,'${it.i}','${type}')"><div class="av-item-ico">${it.i}</div><div class="av-item-nm">${it.n}</div></div>`).join('');
}
function pickAvItem(el,ico,type){document.querySelectorAll('.av-item').forEach(i=>i.classList.remove('sel'));el.classList.add('sel');if(type==='head'){S.ava=ico;document.getElementById('avBig').textContent=ico;}toast('‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ','ok');}
function buildSwatches(){
  document.getElementById('skinRow').innerHTML=SKIN_C.map((c,i)=>`<div class="cswatch ${i===2?'sel':''}" style="background:${c}" onclick="pickSkin(this,'${c}')"></div>`).join('');
  document.getElementById('clothRow').innerHTML=CLOTH_C.map((c,i)=>`<div class="cswatch ${i===1?'sel':''}" style="background:${c}" onclick="pickCloth(this,'${c}')"></div>`).join('');
}
function pickSkin(el,c){document.querySelectorAll('#skinRow .cswatch').forEach(s=>s.classList.remove('sel'));el.classList.add('sel');S.skin=c;}
function pickCloth(el,c){document.querySelectorAll('#clothRow .cswatch').forEach(s=>s.classList.remove('sel'));el.classList.add('sel');S.cloth=c;}
function avNameChange(v){S.pname=v;document.getElementById('avUname').textContent=v||'...';}
function saveAvatar(){document.getElementById('navAvaIco').textContent=S.ava;document.getElementById('topAvatar').textContent=S.ava;S.coins+=50;updateCoins();toast('üéâ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!','ok');}

// STUDIO
let stR=null,stSc,stCam,stAId,stCX=0,stCZ=0,stH=0,stPrev=null,stK={};
function openStudio(){document.getElementById('menuScreen').classList.remove('active');document.getElementById('studioScreen').classList.add('active');buildStColors();setTimeout(initStudio,80);}
function closeStudio(){stopStudio();document.getElementById('studioScreen').classList.remove('active');document.getElementById('menuScreen').classList.add('active');}
function stopStudio(){if(stAId){cancelAnimationFrame(stAId);stAId=null;}if(stR){stR.dispose();stR=null;}stSc=null;stCam=null;stPrev=null;}
function buildStColors(){document.getElementById('stColors').innerHTML=ST_C.map((c,i)=>`<div class="mini-swatch ${i===0?'sel':''}" style="background:${c}" onclick="pickStCol(this,'${c}')"></div>`).join('');}
function pickStCol(el,c){document.querySelectorAll('#stColors .mini-swatch').forEach(s=>s.classList.remove('sel'));el.classList.add('sel');S.stColor=c;if(stPrev)stPrev.material.color.set(c);}
function selTool(el,tool){document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));el.classList.add('active');S.stool=tool;}
function initStudio(){
  stopStudio();
  const canvas=document.getElementById('studioCanvas');
  const area=document.getElementById('stCanvasArea');
  const W=area.clientWidth||800,H=area.clientHeight||600;
  canvas.width=W;canvas.height=H;canvas.style.width=W+'px';canvas.style.height=H+'px';
  stSc=new THREE.Scene();stSc.background=new THREE.Color(0x0B0C18);
  stCam=new THREE.PerspectiveCamera(60,W/H,0.1,500);stCam.position.set(12,16,22);stCam.lookAt(0,0,0);
  stR=new THREE.WebGLRenderer({canvas,antialias:true});stR.setSize(W,H);stR.shadowMap.enabled=true;
  stSc.add(new THREE.AmbientLight(0xffffff,0.7));
  const dl=new THREE.DirectionalLight(0xffffff,0.8);dl.position.set(20,30,20);dl.castShadow=true;stSc.add(dl);
  const gm=new THREE.Mesh(new THREE.PlaneGeometry(80,80),new THREE.MeshLambertMaterial({color:0x1C1F2E}));gm.rotation.x=-Math.PI/2;gm.receiveShadow=true;stSc.add(gm);
  stSc.add(new THREE.GridHelper(80,40,0x2E3250,0x2E3250));
  stPrev=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),new THREE.MeshLambertMaterial({color:S.stColor,transparent:true,opacity:0.4}));stSc.add(stPrev);
  S.stObjs.forEach(o=>{if(!o.m3){const m=mkMesh(o.tool,o.color);m.position.set(o.x,o.y+0.5,o.z);stSc.add(m);o.m3=m;}});
  canvas.addEventListener('click',stPlace);canvas.addEventListener('contextmenu',e=>{e.preventDefault();stDelete(e);});
  canvas.addEventListener('wheel',e=>{stH=Math.max(0,Math.min(20,stH+(e.deltaY>0?-1:1)));},{passive:true});
  canvas.addEventListener('mousemove',stPrevUp);
  const kd=e=>stK[e.code]=true;const ku=e=>stK[e.code]=false;
  window.addEventListener('keydown',kd);window.addEventListener('keyup',ku);
  (function stLoop(){
    stAId=requestAnimationFrame(stLoop);
    if(!stR||!stSc||!stCam)return;
    if(stK['KeyA']||stK['ArrowLeft'])stCX-=0.2;if(stK['KeyD']||stK['ArrowRight'])stCX+=0.2;
    if(stK['KeyW']||stK['ArrowUp'])stCZ-=0.2;if(stK['KeyS']||stK['ArrowDown'])stCZ+=0.2;
    stCam.position.x=12+stCX;stCam.position.z=22+stCZ;stCam.lookAt(stCX,0,stCZ);
    stR.render(stSc,stCam);
  })();
}
function mkMesh(tool,color){
  let geo;if(tool==='sphere')geo=new THREE.SphereGeometry(0.5,10,10);else if(tool==='cyl')geo=new THREE.CylinderGeometry(0.4,0.4,1,12);else if(tool==='spawn')geo=new THREE.CylinderGeometry(0.5,0.5,0.1,16);else geo=new THREE.BoxGeometry(1,1,1);
  const m=new THREE.Mesh(geo,new THREE.MeshLambertMaterial({color}));m.castShadow=true;m.receiveShadow=true;return m;
}
function stGetPos(e){
  const c=document.getElementById('studioCanvas'),r=c.getBoundingClientRect();
  const mx=((e.clientX-r.left)/r.width)*2-1,my=-((e.clientY-r.top)/r.height)*2+1;
  const rc=new THREE.Raycaster();rc.setFromCamera({x:mx,y:my},stCam);
  const pl=new THREE.Plane(new THREE.Vector3(0,1,0),-stH),t=new THREE.Vector3();rc.ray.intersectPlane(pl,t);
  return{x:Math.round(t.x),y:stH,z:Math.round(t.z)};
}
function stPrevUp(e){if(!stPrev||!stCam)return;try{const p=stGetPos(e);stPrev.position.set(p.x,p.y+0.5,p.z);stPrev.material.color.set(S.stColor);}catch(ex){}}
function stPlace(e){
  if(!stSc||!stR||!stCam)return;if(S.stool==='delete'){stDelete(e);return;}
  try{const p=stGetPos(e);const m=mkMesh(S.stool,S.stColor);m.position.set(p.x,p.y+0.5,p.z);stSc.add(m);S.stObjs.push({tool:S.stool,color:S.stColor,x:p.x,y:p.y,z:p.z,m3:m});S.stPlaced++;document.getElementById('placedCnt').textContent='–û–±—ä–µ–∫—Ç–æ–≤: '+S.stPlaced;S.coins+=2;updateCoins();}catch(ex){}
}
function stDelete(e){
  if(!stSc||!stCam)return;
  try{const p=stGetPos(e);const idx=S.stObjs.findIndex(o=>Math.abs(o.x-p.x)<1&&Math.abs(o.z-p.z)<1&&Math.abs(o.y-p.y)<1.5);if(idx!==-1){stSc.remove(S.stObjs[idx].m3);S.stObjs.splice(idx,1);S.stPlaced=Math.max(0,S.stPlaced-1);document.getElementById('placedCnt').textContent='–û–±—ä–µ–∫—Ç–æ–≤: '+S.stPlaced;}}catch(ex){}
}
function clearAll(){S.stObjs.forEach(o=>{if(stSc&&o.m3)stSc.remove(o.m3);});S.stObjs=[];S.stPlaced=0;document.getElementById('placedCnt').textContent='–û–±—ä–µ–∫—Ç–æ–≤: 0';toast('üßπ –û—á–∏—â–µ–Ω–æ','info');}
function showPublish(){document.getElementById('pubTitle').value=document.getElementById('stName').value||'–ú–æ—è –∏–≥—Ä–∞';document.getElementById('publishModal').classList.add('open');}
function closeModal(){document.getElementById('publishModal').classList.remove('open');}
function doPublish(){
  const title=document.getElementById('pubTitle').value||'–ú–æ—è –∏–≥—Ä–∞';const genre=document.getElementById('pubGenre').value;
  const emos=['üè†','üè∞','üåü','üíé','üéØ','üöÄ','üé™','üåà'],clrs=['#1565C0','#E65100','#4A148C','#33691E','#B71C1C','#006064','#37474F','#880E4F'];
  const i=Math.floor(Math.random()*emos.length);
  S.published.push({id:'p'+Date.now(),title,thumb:emos[i],clr:clrs[i],players:Math.floor(Math.random()*300)+5,genre});
  closeModal();S.coins+=500;updateCoins();toast('üöÄ "'+title+'" –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!','ok');buildHome();buildGamesPage();setTimeout(closeStudio,500);
}

// GAME ENGINE - ALL BUGS FIXED
let gR=null,gSc,gCam,gAId,gPlayer,gVY=0,gOnG=true,gYaw=0,gPitch=0,gLk=false,gK={},gFP=[],gLT=0,gCI=null,gPI=null;
const gMouseMove=e=>{if(!gLk)return;gYaw-=e.movementX*.0025;gPitch=Math.max(-.65,Math.min(.6,gPitch-e.movementY*.0025));};
const gKeyDown=e=>{gK[e.code]=true;if(e.code==='Escape')leaveGame();};
const gKeyUp=e=>{gK[e.code]=false;};
function launchGame(id,title){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('gameScreen').classList.add('active');
  document.getElementById('hudTitle').textContent=title;
  initGame();buildServerPanel_();buildPlayerList_();startFakeChat();startPing();toast('‚úÖ '+title,'ok');
}
function stopGame(){
  if(gAId){cancelAnimationFrame(gAId);gAId=null;}
  if(gR){gR.dispose();gR=null;}
  clearInterval(gCI);clearInterval(gPI);gCI=null;gPI=null;
  document.exitPointerLock?.();
  gK={};gLk=false;gSc=null;gCam=null;gPlayer=null;gFP=[];
  document.removeEventListener('mousemove',gMouseMove);
  window.removeEventListener('keydown',gKeyDown);window.removeEventListener('keyup',gKeyUp);
}
function leaveGame(){stopGame();document.getElementById('gameScreen').classList.remove('active');document.getElementById('menuScreen').classList.add('active');buildHome();}
function initGame(){
  stopGame();
  const canvas=document.getElementById('gameCanvas');
  canvas.width=window.innerWidth;canvas.height=window.innerHeight;
  gSc=new THREE.Scene();gSc.background=new THREE.Color(0x6EA8D8);gSc.fog=new THREE.Fog(0x6EA8D8,70,230);
  gCam=new THREE.PerspectiveCamera(75,canvas.width/canvas.height,.1,500);
  // Create renderer FIRST, then populate scene
  gR=new THREE.WebGLRenderer({canvas,antialias:true,powerPreference:'high-performance'});
  gR.setSize(canvas.width,canvas.height);gR.setPixelRatio(Math.min(window.devicePixelRatio,2));
  gR.shadowMap.enabled=true;gR.shadowMap.type=THREE.PCFSoftShadowMap;
  gSc.add(new THREE.AmbientLight(0xffffff,.55));
  const sun=new THREE.DirectionalLight(0xFFF5E4,1.1);sun.position.set(50,100,50);sun.castShadow=true;
  sun.shadow.mapSize.set(1024,1024);sun.shadow.camera.far=250;sun.shadow.camera.left=sun.shadow.camera.bottom=-100;sun.shadow.camera.right=sun.shadow.camera.top=100;gSc.add(sun);
  const gr=new THREE.Mesh(new THREE.PlaneGeometry(280,280),new THREE.MeshLambertMaterial({color:0x3E8C3E}));gr.rotation.x=-Math.PI/2;gr.receiveShadow=true;gSc.add(gr);
  const grid=new THREE.GridHelper(280,56,0x000000,0x000000);grid.material.opacity=.06;grid.material.transparent=true;gSc.add(grid);
  genWorld_();
  const pg=new THREE.Group();
  const bodyClr=parseInt(S.cloth.replace('#','0x'))||0x0066FF;
  const skinClr=parseInt(S.skin.replace('#','0x'))||0xF4A460;
  const body=new THREE.Mesh(new THREE.BoxGeometry(.8,1.2,.8),new THREE.MeshLambertMaterial({color:bodyClr}));body.position.y=.6;body.castShadow=true;pg.add(body);
  const head=new THREE.Mesh(new THREE.BoxGeometry(.9,.9,.9),new THREE.MeshLambertMaterial({color:skinClr}));head.position.y=1.65;head.castShadow=true;pg.add(head);
  gSc.add(pg);gPlayer=pg;
  gFP=[];
  FD.filter(f=>f.status!=='offline').slice(0,5).forEach((f,i)=>{
    const fp=new THREE.Group();const fc=parseInt(f.bg.replace('#','0x'))||0x1565C0;
    const fb=new THREE.Mesh(new THREE.BoxGeometry(.8,1.2,.8),new THREE.MeshLambertMaterial({color:fc}));fb.position.y=.6;fp.add(fb);
    const fh=new THREE.Mesh(new THREE.BoxGeometry(.9,.9,.9),new THREE.MeshLambertMaterial({color:0xF4A460}));fh.position.y=1.65;fp.add(fh);
    fp.position.set((i-2)*7,0,-12);gSc.add(fp);gFP.push({mesh:fp,t:Math.random()*Math.PI*2});
  });
  canvas.addEventListener('click',()=>canvas.requestPointerLock());
  document.addEventListener('pointerlockchange',()=>{gLk=document.pointerLockElement===canvas;});
  document.addEventListener('mousemove',gMouseMove);window.addEventListener('keydown',gKeyDown);window.addEventListener('keyup',gKeyUp);
  gVY=0;gOnG=true;gYaw=0;gPitch=0;gLT=performance.now();
  (function loop(t){
    gAId=requestAnimationFrame(loop);
    // KEY FIX: check gR exists before EVERY render call
    if(!gR||!gSc||!gCam||!gPlayer)return;
    const dt=Math.min((t-gLT)/1000,.05);gLT=t;if(dt<=0)return;
    const dv=new THREE.Vector3();
    if(gK['KeyW'])dv.z-=1;if(gK['KeyS'])dv.z+=1;if(gK['KeyA'])dv.x-=1;if(gK['KeyD'])dv.x+=1;
    if(dv.length()>0){dv.normalize().multiplyScalar(8*dt);dv.applyEuler(new THREE.Euler(0,gYaw,0));}
    gPlayer.position.add(dv);
    if(gK['Space']&&gOnG){gVY=9;gOnG=false;}
    gVY-=26*dt;gPlayer.position.y+=gVY*dt;
    if(gPlayer.position.y<0){gPlayer.position.y=0;gVY=0;gOnG=true;}
    gPlayer.rotation.y=gYaw;
    gFP.forEach(fp=>{fp.t+=.012;fp.mesh.position.x+=Math.sin(fp.t)*.05;fp.mesh.position.z+=Math.cos(fp.t*.7)*.05;fp.mesh.rotation.y=fp.t;});
    const cd=5.5;
    gCam.position.set(gPlayer.position.x+Math.sin(gYaw)*cd*Math.cos(gPitch),gPlayer.position.y+1.8+Math.sin(gPitch)*cd,gPlayer.position.z+Math.cos(gYaw)*cd*Math.cos(gPitch));
    gCam.lookAt(gPlayer.position.x,gPlayer.position.y+1.2,gPlayer.position.z);
    if((t|0)%5===0){
      const el_px=document.getElementById('px'),el_py=document.getElementById('py'),el_pz=document.getElementById('pz'),el_fps=document.getElementById('fpsVal');
      if(el_px)el_px.textContent=Math.round(gPlayer.position.x);
      if(el_py)el_py.textContent=Math.round(gPlayer.position.y);
      if(el_pz)el_pz.textContent=Math.round(gPlayer.position.z);
      if(el_fps)el_fps.textContent=Math.min(Math.round(1/Math.max(dt,.001)),999);
    }
    gR.render(gSc,gCam);
  })(performance.now());
}
function genWorld_(){
  const clrs=[0xFF3B3B,0x0066FF,0x00C853,0xFFD600,0x9B00FF,0xFF7A00,0xFF69B4,0x00BCD4];
  for(let i=0;i<150;i++){const w=1+Math.floor(Math.random()*5),h=.5+Math.floor(Math.random()*4)*.5,d=1+Math.floor(Math.random()*5);const m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshLambertMaterial({color:clrs[i%clrs.length]}));m.position.set((Math.random()-.5)*130,h/2,(Math.random()-.5)*130);m.castShadow=true;m.receiveShadow=true;gSc.add(m);}
  for(let i=0;i<45;i++){const x=(Math.random()-.5)*110,z=(Math.random()-.5)*110;const t=new THREE.Mesh(new THREE.CylinderGeometry(.3,.45,2.5),new THREE.MeshLambertMaterial({color:0x5D4037}));t.position.set(x,1.25,z);t.castShadow=true;gSc.add(t);const l=new THREE.Mesh(new THREE.SphereGeometry(1.8,8,8),new THREE.MeshLambertMaterial({color:0x388E3C}));l.position.set(x,4,z);l.castShadow=true;gSc.add(l);}
  for(let i=0;i<18;i++){const cx=(Math.random()-.5)*180,cz=(Math.random()-.5)*180,cy=28+Math.random()*18;for(let j=0;j<5;j++){const c=new THREE.Mesh(new THREE.SphereGeometry(2.2+Math.random()*1.8,8,8),new THREE.MeshLambertMaterial({color:0xffffff}));c.position.set(cx+j*3.2,cy,cz+Math.random()*2.5);gSc.add(c);}}
}
function buildServerPanel_(){
  document.getElementById('serverList').innerHTML=SRVS.map(s=>`<div class="sv-item ${s.me?'me':''}"><div class="sv-top"><div class="sv-name">${s.name}${s.me?' üìç':''}</div><div style="font-size:10px;color:${s.ping<60?'var(--green)':s.ping<100?'var(--yellow)':'var(--red)'}">${s.ping}ms</div></div><div class="sv-bar"><div class="sv-fill" style="width:${(s.players/s.max*100)}%"></div></div><div class="sv-meta"><span>${s.players}/${s.max} –∏–≥—Ä–æ–∫–æ–≤</span></div>${!s.me?`<button class="sv-join" onclick="switchSrv('${s.id}','${s.name}')">–ó–∞–π—Ç–∏</button>`:'<div style="font-size:10px;color:var(--green);margin-top:4px;">‚óè –í—ã –∑–¥–µ—Å—å</div>'}</div>`).join('');
}
function toggleSP(){document.getElementById('serverPanel').classList.toggle('open');}
function switchSrv(id,name){toast('üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è...','info');SRVS.forEach(s=>s.me=s.id===id);setTimeout(()=>{buildServerPanel_();toast('‚úÖ '+name,'ok');},700);}
function buildPlayerList_(){
  const names=[S.pname,...FD.filter(f=>f.status!=='offline').slice(0,4).map(f=>f.name)];
  const clrs=['#FFD600','#FF6B6B','#B388FF','#4FC3F7','#80CBC4'];
  document.getElementById('playersList').innerHTML=names.map((n,i)=>`<div class="pl-item"><div class="pl-dot" style="background:${clrs[i]}"></div><div class="pl-name" style="color:${i===0?'var(--yellow)':'var(--text)'}">${n}${i===0?' (–í—ã)':''}</div></div>`).join('');
}
function startFakeChat(){
  document.getElementById('chatLog').innerHTML='';addMsg('üåê –°–µ—Ä–≤–µ—Ä','var(--muted)','–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!');
  gCI=setInterval(()=>{const i=Math.floor(Math.random()*CHAT_N.length);addMsg(CHAT_N[i],CHAT_C[i],CHAT_M[Math.floor(Math.random()*CHAT_M.length)]);},2200+Math.random()*4800);
}
function addMsg(name,color,text){
  const log=document.getElementById('chatLog');if(!log)return;
  const d=document.createElement('div');d.className='chat-msg';d.innerHTML=`<span class="cm-name" style="color:${color}">${name}</span>: ${text}`;
  log.appendChild(d);log.scrollTop=log.scrollHeight;while(log.children.length>50)log.removeChild(log.firstChild);
}
function sendChat(){const inp=document.getElementById('chatInp');const msg=inp.value.trim();if(!msg)return;addMsg(S.pname,'#FFD600',msg);inp.value='';}
function startPing(){let b=18+Math.floor(Math.random()*30);gPI=setInterval(()=>{b+=Math.floor(Math.random()*10)-4;b=Math.max(12,Math.min(150,b));const el=document.getElementById('pingVal');if(el){el.textContent=b+'ms';el.style.color=b<60?'var(--green)':b<100?'var(--yellow)':'var(--red)';}},2000);}
function updateCoins(){document.getElementById('coinsVal').textContent=S.coins.toLocaleString('ru');}
function toast(msg,type='info'){const c=document.getElementById('toasts');const el=document.createElement('div');el.className='toast '+type;el.textContent=msg;c.appendChild(el);setTimeout(()=>{el.style.opacity='0';el.style.transform='translateX(60px)';el.style.transition='.3s';setTimeout(()=>el.remove(),300);},2800);}
window.addEventListener('resize',()=>{
  if(gR&&gCam){const c=document.getElementById('gameCanvas');c.width=window.innerWidth;c.height=window.innerHeight;gR.setSize(window.innerWidth,window.innerHeight);gCam.aspect=window.innerWidth/window.innerHeight;gCam.updateProjectionMatrix();}
});
window.addEventListener('load',()=>{buildHome();buildGamesPage();buildFriends();updateCoins();let n=12847;setInterval(()=>{n+=Math.floor(Math.random()*12)-5;document.getElementById('onlineCnt').textContent=n.toLocaleString('ru');},3000);toast('üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!','ok');});
</script>
</body>
</html>
