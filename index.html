<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>BLOCKVERSE ‚Äî 3D Game Platform</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0e1a;
  --surface: #141826;
  --surface2: #1c2138;
  --accent: #ff4d6d;
  --accent2: #7c3aed;
  --accent3: #06d6a0;
  --text: #e8eaf6;
  --text2: #8892b0;
  --border: rgba(255,255,255,0.06);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { 
  font-family: 'Comic Sans MS', 'Nunito', cursive, sans-serif;
  background: var(--bg);
  color: var(--text);
  overflow: hidden;
  height: 100vh;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}

.screen { 
  position: absolute; inset: 0; 
  display: none; 
  flex-direction: column;
  overflow: hidden;
}
.screen.active { display: flex; }

/* ===== AUTH ===== */
#authScreen {
  background: radial-gradient(ellipse at 30% 40%, #1a0533 0%, #0a0e1a 60%);
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.auth-box {
  width: 100%;
  max-width: 440px;
  background: rgba(20,24,38,0.95);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 40px 32px;
  backdrop-filter: blur(20px);
  box-shadow: 0 20px 60px rgba(0,0,0,0.6);
}
@media (max-width: 768px) {
  .auth-box { padding: 30px 24px; }
}
.auth-logo {
  font-family: 'Fredoka One', cursive;
  font-size: 52px;
  background: linear-gradient(135deg, #ff4d6d, #7c3aed, #06d6a0);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-align: center;
  margin-bottom: 6px;
  animation: logoGlow 3s ease-in-out infinite;
}
@keyframes logoGlow { 0%,100%{filter:drop-shadow(0 0 20px rgba(124,58,237,0.4))} 50%{filter:drop-shadow(0 0 40px rgba(255,77,109,0.6))} }
.auth-subtitle {
  text-align: center;
  color: var(--text2);
  font-size: 13px;
  margin-bottom: 32px;
  letter-spacing: 2px;
  text-transform: uppercase;
}
.auth-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 28px;
  background: rgba(255,255,255,0.02);
  border-radius: 12px;
  padding: 4px;
}
.auth-tab {
  flex: 1;
  padding: 12px;
  border: none;
  background: transparent;
  color: var(--text2);
  font-family: 'Comic Sans MS', cursive;
  font-size: 15px;
  font-weight: 700;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
}
.auth-tab.active {
  background: linear-gradient(135deg, rgba(255,77,109,0.15), rgba(124,58,237,0.15));
  color: var(--text);
}
.auth-form { display: none; }
.auth-form.active { display: block; }
.auth-field { margin-bottom: 16px; }
.auth-label {
  display: block;
  font-size: 13px;
  font-weight: 700;
  color: var(--text2);
  margin-bottom: 8px;
}
.auth-input {
  width: 100%;
  background: rgba(10,14,26,0.6);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 14px 16px;
  color: var(--text);
  font-family: 'Comic Sans MS', cursive;
  font-size: 15px;
  outline: none;
  transition: all 0.2s;
}
.auth-input:focus {
  border-color: #ff4d6d;
  background: rgba(10,14,26,0.8);
}
.auth-checkbox {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 20px;
}
.auth-submit {
  width: 100%;
  background: linear-gradient(135deg, #ff4d6d, #c02045);
  border: none;
  border-radius: 12px;
  padding: 16px;
  color: white;
  font-family: 'Comic Sans MS', cursive;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
}
.auth-submit:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(255,77,109,0.5);
}
.auth-error {
  background: rgba(255,77,109,0.1);
  border: 1px solid rgba(255,77,109,0.3);
  border-radius: 10px;
  padding: 12px 16px;
  color: #ff4d6d;
  font-size: 13px;
  margin-bottom: 16px;
  display: none;
}
.auth-error.show { display: block; }

/* ===== LOADING ===== */
#loadingScreen {
  background: radial-gradient(ellipse at 50% 50%, #1a0533 0%, #0a0e1a 70%);
  align-items: center;
  justify-content: center;
  gap: 32px;
}
.logo-main {
  font-family: 'Fredoka One', cursive;
  font-size: 72px;
  background: linear-gradient(135deg, #ff4d6d, #7c3aed, #06d6a0);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: logoPulse 2s ease-in-out infinite;
}
@keyframes logoPulse { 0%,100%{filter:drop-shadow(0 0 40px rgba(124,58,237,0.5))} 50%{filter:drop-shadow(0 0 80px rgba(255,77,109,0.8))} }
.load-bar-wrap { width:320px; height:6px; background:rgba(255,255,255,0.08); border-radius:99px; overflow:hidden; }
.load-bar { height:100%; width:0%; background:linear-gradient(90deg, #ff4d6d, #7c3aed, #06d6a0); border-radius:99px; transition:width 0.1s; }

/* ===== MAIN MENU ===== */
#mainMenu {
  background: radial-gradient(ellipse at 30% 30%, #1a0533 0%, #0a0e1a 60%);
  flex-direction: row;
}
.menu-sidebar {
  width: 260px;
  background: rgba(20,24,38,0.98);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  padding: 20px 12px;
  gap: 4px;
  flex-shrink: 0;
}
.menu-sidebar.mobile-hide { display: flex; }
.sidebar-logo {
  font-family: 'Fredoka One', cursive;
  font-size: 24px;
  background: linear-gradient(135deg, #ff4d6d, #7c3aed);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  padding: 8px 12px 16px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 8px;
}
.menu-btn {
  display: flex; align-items: center; gap: 10px;
  padding: 11px 14px; border-radius: 10px;
  border: none; background: transparent; color: var(--text2);
  font-family: 'Comic Sans MS', cursive; font-size: 14px; font-weight: 700;
  cursor: pointer; transition: all 0.15s; width: 100%; text-align: left;
}
.menu-btn:hover { background: rgba(255,255,255,0.05); color: var(--text); }
.menu-btn.active { background: linear-gradient(135deg, rgba(255,77,109,0.15), rgba(124,58,237,0.15)); color: var(--text); }
.menu-btn .btn-icon { font-size: 18px; width: 20px; text-align: center; }
.avatar-mini {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px; background: rgba(255,255,255,0.04);
  border-radius: 10px; cursor: pointer; transition: all 0.2s;
  margin-top: auto;
}
.avatar-mini:hover { background: rgba(255,255,255,0.08); }
.avatar-head-mini {
  width: 36px; height: 36px; border-radius: 8px;
  background: linear-gradient(135deg, #ff4d6d, #7c3aed);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px;
}
.menu-content { flex: 1; overflow: hidden; }

/* Mobile Nav */
.mobile-nav {
  display: none;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(20,24,38,0.98);
  border-top: 1px solid var(--border);
  padding: 6px 0;
  z-index: 100;
  backdrop-filter: blur(10px);
}
.mobile-nav.mobile-show { display: block; }
.mobile-nav-items {
  display: flex;
  justify-content: space-around;
}
.mobile-nav-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  padding: 6px 10px;
  border: none;
  background: transparent;
  color: var(--text2);
  font-family: 'Comic Sans MS', cursive;
  font-size: 10px;
  font-weight: 700;
  cursor: pointer;
}
.mobile-nav-btn .nav-icon { font-size: 20px; }
.mobile-nav-btn.active { color: #ff4d6d; }

/* ===== TABS ===== */
.tab-content { display: none; height: 100%; overflow-y: auto; }
.tab-content.active { display: block; }
.home-wrap { padding: 28px; }
.home-wrap.mobile-padding { padding: 14px; padding-bottom: 75px; }
.home-banner {
  background: linear-gradient(135deg, #1a0533, #0d1a33);
  border: 1px solid var(--border);
  border-radius: 18px; padding: 36px;
  position: relative; overflow: hidden; margin-bottom: 28px;
}
.home-banner.mobile-padding { padding: 20px; }
.banner-title { font-family:'Fredoka One',cursive; font-size:38px; margin-bottom:6px; }
.banner-title.mobile-size { font-size: 26px; }
.banner-sub { color:var(--text2); font-size:14px; margin-bottom:20px; }
.banner-btn {
  background: linear-gradient(135deg, #ff4d6d, #c02045);
  border: none; border-radius: 10px; padding: 13px 26px;
  font-family: 'Comic Sans MS', cursive; font-size:14px; font-weight:700;
  color: white; cursor: pointer; transition:all 0.2s;
}
.banner-btn:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(255,77,109,0.4); }
.section-title { font-size:18px; font-weight:800; margin-bottom:14px; display:flex; align-items:center; gap:6px; }
.games-grid { 
  display:grid; 
  grid-template-columns:repeat(auto-fill,minmax(190px,1fr)); 
  gap:14px; 
  margin-bottom:28px; 
}
.games-grid.mobile-grid {
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}
.game-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px; overflow:hidden; cursor:pointer;
  transition: all 0.2s; position:relative;
}
.game-card:hover { transform:translateY(-3px); border-color:rgba(255,77,109,0.3); box-shadow:0 10px 28px rgba(0,0,0,0.4); }
.game-thumb {
  height: 110px; display:flex; align-items:center; justify-content:center;
  font-size:42px; position:relative; overflow:hidden;
}
.game-thumb-bg { position:absolute; inset:0; }
.game-info { padding:10px; }
.game-name { font-size:13px; font-weight:700; margin-bottom:3px; }
.game-players { font-size:11px; color:var(--accent3); font-weight:600; }
.game-genre { font-size:10px; color:var(--text2); margin-top:3px; }
.game-badge {
  position:absolute; top:6px; right:6px;
  background:rgba(255,77,109,0.95); color:white;
  font-size:10px; font-weight:800; padding:2px 7px; border-radius:99px;
}
.saved-indicator {
  position: absolute; top: 6px; left: 6px;
  width: 24px; height: 24px;
  background: rgba(6,214,160,0.95);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px;
}

/* ===== FRIENDS ===== */
.friends-wrap { padding:28px; }
.friends-wrap.mobile-padding { padding: 14px; padding-bottom: 75px; }
.friends-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap: wrap; gap: 14px; }
.add-btn {
  background:linear-gradient(135deg,#ff4d6d,#c02045);
  border:none; border-radius:10px; padding:11px 18px;
  color:white; font-family: 'Comic Sans MS', cursive; font-size:13px; font-weight:700;
  cursor:pointer; transition:all 0.2s; display:flex; align-items:center; gap:6px;
}
.friend-list { display:flex; flex-direction:column; gap:6px; }
.friend-item {
  display:flex; align-items:center; gap:12px;
  padding:12px 14px; background:var(--surface);
  border:1px solid var(--border); border-radius:10px; cursor:pointer;
  transition:all 0.2s;
}
.friend-item:hover { border-color:rgba(255,77,109,0.3); background:var(--surface2); }
.friend-ava {
  width:40px; height:40px; border-radius:8px;
  display:flex; align-items:center; justify-content:center;
  font-size:20px; flex-shrink:0; position:relative;
}
.online-dot {
  position:absolute; bottom:1px; right:1px;
  width:9px; height:9px; border-radius:50%;
  border:2px solid var(--surface); background:#06d6a0;
}
.online-dot.offline { background:#666; }
.friend-info { flex:1; min-width: 0; }
.friend-name { font-size:13px; font-weight:700; }
.friend-status { font-size:11px; color:var(--text2); margin-top:2px; }

/* ===== STUDIO ===== */
.studio-wrap { height:100%; display:flex; flex-direction:column; }
.studio-toolbar {
  background:var(--surface); border-bottom:1px solid var(--border);
  padding:10px 16px; display:flex; align-items:center; gap:8px; flex-shrink:0; overflow-x:auto;
}
.tool-btn {
  display:flex; align-items:center; gap:5px;
  background:rgba(255,255,255,0.05); border:1px solid var(--border);
  border-radius:8px; padding:7px 12px; color:var(--text);
  font-family: 'Comic Sans MS', cursive; font-size:12px; font-weight:700; white-space:nowrap;
  cursor:pointer; transition:all 0.2s;
}
.tool-btn:hover { background:rgba(255,255,255,0.1); }
.tool-btn.active { background:rgba(255,77,109,0.2); border-color:rgba(255,77,109,0.5); color:#ff4d6d; }
.studio-main { flex:1; display:flex; overflow:hidden; }
.studio-left {
  width:200px; background:var(--surface); border-right:1px solid var(--border);
  padding:10px; overflow-y:auto; flex-shrink:0;
}
.studio-left.mobile-hide { display: block; }
.studio-canvas-wrap { flex:1; position:relative; overflow:hidden; }
#studioCanvas { width:100%; height:100%; display:block; }
.studio-right {
  width:200px; background:var(--surface); border-left:1px solid var(--border);
  padding:10px; overflow-y:auto; flex-shrink:0;
}
.studio-right.mobile-hide { display: block; }
.prop-label { font-size:11px; color:var(--text2); font-weight:700; margin-bottom:5px; }
.prop-input {
  width:100%; background:var(--bg); border:1px solid var(--border);
  border-radius:8px; padding:7px 10px; color:var(--text);
  font-family: 'Comic Sans MS', cursive; font-size:12px; outline:none;
}
.color-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:3px; }
.color-swatch {
  aspect-ratio:1; border-radius:5px; cursor:pointer; border:2px solid transparent;
}
.color-swatch.active { border-color:white; }

/* ===== AVATAR ===== */
.avatar-wrap { padding:28px; display:flex; gap:28px; height:100%; overflow-y:auto; }
.avatar-wrap.mobile-style {
  padding: 14px;
  flex-direction: column;
  padding-bottom: 75px;
}
.avatar-preview-panel { 
  width:320px; flex-shrink:0;
  background:var(--surface); border:1px solid var(--border);
  border-radius:18px; padding:20px; display:flex; flex-direction:column; align-items:center; gap:16px;
  height:fit-content;
}
.avatar-preview-panel.mobile-full { width: 100%; }
.avatar-3d-wrap { 
  width:200px; height:260px; position:relative; border-radius:12px;
  background: radial-gradient(ellipse at 50% 80%, rgba(124,58,237,0.2), transparent);
  overflow:hidden;
}
#avatarCanvas { width:100%; height:100%; display:block; }
.avatar-equip-btn {
  width:100%; background:linear-gradient(135deg,#7c3aed,#4c1d95);
  border:none; border-radius:10px; padding:11px;
  color:white; font-family: 'Comic Sans MS', cursive; font-size:13px; font-weight:700;
  cursor:pointer; transition:all 0.2s;
}
.avatar-customize { flex:1; overflow-y:auto; }
.customize-section { margin-bottom:20px; }
.section-label { font-size:15px; font-weight:800; margin-bottom:12px; display:flex; align-items:center; gap:6px; }
.skin-grid { display:grid; grid-template-columns:repeat(8,1fr); gap:6px; }
.skin-grid.mobile-grid { grid-template-columns: repeat(6, 1fr); }
.skin-swatch {
  aspect-ratio:1; border-radius:6px; cursor:pointer; border:2.5px solid transparent;
}
.skin-swatch.active { border-color:white; }
.items-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
.items-grid.mobile-grid { grid-template-columns: repeat(3, 1fr); }
.item-card {
  background:var(--surface); border:2px solid var(--border);
  border-radius:10px; padding:10px; cursor:pointer; transition:all 0.2s;
  text-align:center; display:flex; flex-direction:column; align-items:center; gap:6px;
}
.item-card:hover { border-color:rgba(255,77,109,0.5); }
.item-card.selected { border-color:#ff4d6d; background:rgba(255,77,109,0.1); }
.item-icon { font-size:32px; }
.item-name { font-size:11px; font-weight:700; color:var(--text2); }

/* ===== GAME SCREEN ===== */
#gameScreen { background:#000; position:relative; }
#gameCanvas { width:100%; height:100%; display:block; }
.game-hud { position:absolute; inset:0; pointer-events:none; }
.hud-top {
  display:flex; justify-content:space-between; align-items:flex-start;
  padding:14px; pointer-events:all;
}
.hud-health {
  background:rgba(0,0,0,0.75); border:1px solid rgba(255,255,255,0.12);
  border-radius:10px; padding:9px 14px; backdrop-filter:blur(10px);
  display:flex; align-items:center; gap:9px;
}
.health-bar-wrap { width:100px; height:7px; background:rgba(255,255,255,0.15); border-radius:99px; overflow:hidden; }
.health-bar { height:100%; background:linear-gradient(90deg,#ff4d6d,#ff6b6b); border-radius:99px; }
.game-title-hud { font-family:'Fredoka One',cursive; font-size:20px; color:white; text-shadow:0 2px 8px rgba(0,0,0,0.9); }
.hud-exit {
  background:rgba(255,77,109,0.85); border:none; border-radius:8px;
  padding:9px 14px; color:white; font-family: 'Comic Sans MS', cursive; font-size:12px; font-weight:700;
  cursor:pointer; pointer-events:all;
}
.hud-players {
  position:absolute; top:55px; right:14px;
  background:rgba(0,0,0,0.75); border:1px solid rgba(255,255,255,0.1);
  border-radius:10px; padding:10px 14px; backdrop-filter:blur(10px);
  min-width:160px;
}
.players-title { font-size:10px; font-weight:800; color:#aaa; text-transform:uppercase; letter-spacing:1.5px; margin-bottom:7px; }
.player-in-game { display:flex; align-items:center; gap:7px; margin-bottom:5px; }
.player-dot { width:7px; height:7px; border-radius:50%; background:#06d6a0; animation:pulse 2s ease-in-out infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
.player-name-hud { font-size:12px; font-weight:700; }
.hud-chat {
  position:absolute; bottom:14px; right:14px;
  background:rgba(0,0,0,0.75); border:1px solid rgba(255,255,255,0.1);
  border-radius:10px; padding:10px; backdrop-filter:blur(10px);
  width:240px;
}
.hud-chat.mobile-size { width: 180px; }
.chat-messages { 
  height:100px; overflow-y:auto; margin-bottom:7px;
  display:flex; flex-direction:column; gap:3px;
}
.chat-msg { font-size:12px; }
.chat-sender { font-weight:800; color:#ffd60a; }
.chat-input {
  flex:1; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.15);
  border-radius:7px; padding:7px 10px; color:white;
  font-family: 'Comic Sans MS', cursive; font-size:12px; outline:none; pointer-events:all;
}

/* Mobile Controls */
.mobile-controls {
  display: none;
  position: absolute;
  bottom: 70px;
  left: 0;
  right: 0;
  padding: 18px;
  pointer-events: all;
}
.mobile-controls.mobile-show {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
}
.joystick {
  width: 110px;
  height: 110px;
  background: rgba(255,255,255,0.08);
  border: 2px solid rgba(255,255,255,0.15);
  border-radius: 50%;
  position: relative;
}
.joystick-knob {
  width: 45px;
  height: 45px;
  background: rgba(255,77,109,0.85);
  border: 2.5px solid rgba(255,255,255,0.4);
  border-radius: 50%;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}
.action-btns {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.action-btn {
  width: 55px;
  height: 55px;
  background: rgba(124,58,237,0.75);
  border: 2.5px solid rgba(255,255,255,0.25);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  cursor: pointer;
}
.action-btn:active {
  transform: scale(0.92);
  background: rgba(124,58,237,0.95);
}

::-webkit-scrollbar { width:3px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.12); border-radius:99px; }
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div class="screen active" id="authScreen">
  <div class="auth-box">
    <div class="auth-logo">‚¨õ BLOCKVERSE</div>
    <div class="auth-subtitle">–ò–ì–†–ê–ô ‚Ä¢ –°–û–ó–î–ê–í–ê–ô ‚Ä¢ –ü–û–ë–ï–ñ–î–ê–ô</div>
    
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">–í—Ö–æ–¥</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>

    <div class="auth-error" id="authError">–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</div>

    <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
      <div class="auth-field">
        <label class="auth-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
        <input class="auth-input" type="text" id="loginUsername" placeholder="–í–≤–µ–¥–∏–°–≤–æ–π–ù–∏–∫" required autocomplete="username">
      </div>
      <div class="auth-field">
        <label class="auth-label">–ü–∞—Ä–æ–ª—å</label>
        <input class="auth-input" type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
      </div>
      <div class="auth-checkbox">
        <input type="checkbox" id="remember">
        <label for="remember" style="font-size:12px;color:var(--text2);">–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label>
      </div>
      <button class="auth-submit" type="submit">üéÆ –í–æ–π—Ç–∏ –≤ –∏–≥—Ä—É</button>
    </form>

    <form class="auth-form" id="registerForm" onsubmit="handleRegister(event)">
      <div class="auth-field">
        <label class="auth-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
        <input class="auth-input" type="text" id="regUsername" placeholder="–ü—Ä–∏–¥—É–º–∞–π –∫—Ä—É—Ç–æ–π –Ω–∏–∫" required minlength="3" autocomplete="username">
      </div>
      <div class="auth-field">
        <label class="auth-label">Email</label>
        <input class="auth-input" type="email" id="regEmail" placeholder="—Ç–≤–æ–π@email.com" required autocomplete="email">
      </div>
      <div class="auth-field">
        <label class="auth-label">–ü–∞—Ä–æ–ª—å</label>
        <input class="auth-input" type="password" id="regPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6" autocomplete="new-password">
      </div>
      <div class="auth-field">
        <label class="auth-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –ø–∞—Ä–æ–ª—å</label>
        <input class="auth-input" type="password" id="regPasswordConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6" autocomplete="new-password">
      </div>
      <div class="auth-checkbox">
        <input type="checkbox" id="agreeTerms" required>
        <label for="agreeTerms" style="font-size:12px;color:var(--text2);">–Ø —Å–æ–≥–ª–∞—Å–µ–Ω —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏</label>
      </div>
      <button class="auth-submit" type="submit">üöÄ –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    </form>
  </div>
</div>

<!-- LOADING SCREEN -->
<div class="screen" id="loadingScreen">
  <div style="text-align:center;">
    <div class="logo-main">BLOCKVERSE</div>
    <div style="font-size:14px;color:var(--text2);letter-spacing:4px;text-transform:uppercase;margin-top:6px;">3D GAME PLATFORM</div>
  </div>
  <div class="load-bar-wrap"><div class="load-bar" id="loadBar"></div></div>
  <div style="font-size:13px;color:var(--text2);" id="loadText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<!-- MAIN MENU -->
<div class="screen" id="mainMenu">
  <div class="menu-sidebar" id="menuSidebar">
    <div class="sidebar-logo">‚¨õ BLOCKVERSE</div>
    <button class="menu-btn active" onclick="switchTab('home')" id="btnHome">
      <span class="btn-icon">üè†</span> –ì–ª–∞–≤–Ω–∞—è
    </button>
    <button class="menu-btn" onclick="switchTab('friends')" id="btnFriends">
      <span class="btn-icon">üë•</span> –î—Ä—É–∑—å—è
    </button>
    <button class="menu-btn" onclick="switchTab('studio')" id="btnStudio">
      <span class="btn-icon">üîß</span> –°—Ç—É–¥–∏—è
    </button>
    <button class="menu-btn" onclick="switchTab('avatar')" id="btnAvatar">
      <span class="btn-icon">üßë</span> –ê–≤–∞—Ç–∞—Ä
    </button>
    <div class="avatar-mini" onclick="switchTab('avatar')">
      <div class="avatar-head-mini">üßë</div>
      <div>
        <div style="font-size:13px;font-weight:700;" id="playerNameDisplay">–ò–≥—Ä–æ–∫</div>
        <div style="font-size:11px;color:var(--text2);" id="playerLevel">–£—Ä–æ–≤–µ–Ω—å 1</div>
      </div>
    </div>
  </div>
  
  <div class="menu-content">
    <!-- HOME -->
    <div class="tab-content active" id="tabHome">
      <div class="home-wrap" id="homeWrap">
        <div class="home-banner" id="homeBanner">
          <div class="banner-title" id="bannerTitle">–ò–≥—Ä–∞–π. –°–æ–∑–¥–∞–≤–∞–π. –î–µ–ª–∏—Å—å!</div>
          <div class="banner-sub">–¢—ã—Å—è—á–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö 3D –º–∏—Ä–æ–≤</div>
          <button class="banner-btn" onclick="launchRandomGame()">üéÆ –ò–≥—Ä–∞—Ç—å —Å–µ–π—á–∞—Å</button>
        </div>
        <div class="section-title">üî• –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∏–≥—Ä—ã</div>
        <div class="games-grid" id="gamesGrid"></div>
        <div class="section-title">üÜï –ù–æ–≤—ã–µ –∏–≥—Ä—ã</div>
        <div class="games-grid" id="newGamesGrid"></div>
      </div>
    </div>
    
    <!-- FRIENDS -->
    <div class="tab-content" id="tabFriends">
      <div class="friends-wrap" id="friendsWrap">
        <div class="friends-header">
          <div>
            <div style="font-size:20px;font-weight:800;margin-bottom:3px;">–ú–æ–∏ –¥—Ä—É–∑—å—è</div>
            <div style="color:var(--text2);font-size:13px;">3 –æ–Ω–ª–∞–π–Ω</div>
          </div>
          <button class="add-btn" onclick="showAddFriend()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="friend-list" id="friendList"></div>
      </div>
    </div>
    
    <!-- STUDIO -->
    <div class="tab-content" id="tabStudio" style="padding:0;height:100%;">
      <div class="studio-wrap">
        <div class="studio-toolbar">
          <button class="tool-btn active" onclick="setTool('select')">‚ÜñÔ∏è –í—ã–±—Ä–∞—Ç—å</button>
          <button class="tool-btn" onclick="setTool('place')">üß± –ë–ª–æ–∫</button>
          <button class="tool-btn" onclick="setTool('delete')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          <button class="tool-btn" onclick="clearStudio()">üîÑ –û—á–∏—Å—Ç–∏—Ç—å</button>
          <button class="tool-btn" onclick="testPlay()">‚ñ∂Ô∏è –¢–µ—Å—Ç</button>
          <button class="tool-btn" style="margin-left:auto;background:rgba(6,214,160,0.12);color:#06d6a0;" onclick="publishStudioGame()">üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
        <div class="studio-main">
          <div class="studio-left" id="studioLeft">
            <div style="font-size:10px;font-weight:800;color:var(--text2);margin-bottom:8px;">–û–ë–™–ï–ö–¢–´</div>
            <div id="objList"></div>
          </div>
          <div class="studio-canvas-wrap">
            <canvas id="studioCanvas"></canvas>
          </div>
          <div class="studio-right" id="studioRight">
            <div style="font-size:10px;font-weight:800;color:var(--text2);margin-bottom:8px;">–°–í–û–ô–°–¢–í–ê</div>
            <div style="margin-bottom:12px;">
              <div class="prop-label">–¶–≤–µ—Ç</div>
              <div class="color-grid" id="studioColors"></div>
            </div>
            <div style="margin-bottom:12px;">
              <div class="prop-label">–ú–∞—Ç–µ—Ä–∏–∞–ª</div>
              <select class="prop-input">
                <option>–û–±—ã—á–Ω—ã–π</option>
                <option>–ú–µ—Ç–∞–ª–ª</option>
                <option>–°—Ç–µ–∫–ª–æ</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- AVATAR -->
    <div class="tab-content" id="tabAvatar">
      <div class="avatar-wrap" id="avatarWrap">
        <div class="avatar-preview-panel" id="avatarPreview">
          <div class="avatar-3d-wrap">
            <canvas id="avatarCanvas"></canvas>
          </div>
          <div style="font-size:20px;font-weight:800;" id="avatarNameDisplay">–ò–≥—Ä–æ–∫</div>
          <div style="font-size:12px;color:var(--text2);text-align:center;">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</div>
          <button class="avatar-equip-btn" onclick="randomizeAvatar()">üé≤ –°–ª—É—á–∞–π–Ω—ã–π –æ–±—Ä–∞–∑</button>
        </div>
        <div class="avatar-customize">
          <div class="customize-section">
            <div class="section-label">üé® –¶–≤–µ—Ç –∫–æ–∂–∏</div>
            <div class="skin-grid" id="skinGrid"></div>
          </div>
          <div class="customize-section">
            <div class="section-label">üëï –†—É–±–∞—à–∫–∞</div>
            <div class="items-grid" id="shirtGrid"></div>
          </div>
          <div class="customize-section">
            <div class="section-label">üëñ –®—Ç–∞–Ω—ã</div>
            <div class="items-grid" id="pantsGrid"></div>
          </div>
          <div class="customize-section">
            <div class="section-label">üíá –ü—Ä–∏—á—ë—Å–∫–∞</div>
            <div class="items-grid" id="hairGrid"></div>
          </div>
          <div class="customize-section">
            <div class="section-label">üé© –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</div>
            <div class="items-grid" id="accGrid"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Navigation -->
  <div class="mobile-nav" id="mobileNav">
    <div class="mobile-nav-items">
      <button class="mobile-nav-btn active" onclick="switchTab('home')">
        <div class="nav-icon">üè†</div>
        <div>–ì–ª–∞–≤–Ω–∞—è</div>
      </button>
      <button class="mobile-nav-btn" onclick="switchTab('friends')">
        <div class="nav-icon">üë•</div>
        <div>–î—Ä—É–∑—å—è</div>
      </button>
      <button class="mobile-nav-btn" onclick="switchTab('studio')">
        <div class="nav-icon">üîß</div>
        <div>–°—Ç—É–¥–∏—è</div>
      </button>
      <button class="mobile-nav-btn" onclick="switchTab('avatar')">
        <div class="nav-icon">üßë</div>
        <div>–ê–≤–∞—Ç–∞—Ä</div>
      </button>
    </div>
  </div>
</div>

<!-- GAME SCREEN -->
<div class="screen" id="gameScreen">
  <canvas id="gameCanvas"></canvas>
  <div class="game-hud">
    <div class="hud-top">
      <div class="hud-health">
        <span>‚ù§Ô∏è</span>
        <div>
          <div style="font-size:11px;color:#aaa;font-weight:700;">HP</div>
          <div class="health-bar-wrap"><div class="health-bar" id="healthBar" style="width:100%"></div></div>
        </div>
      </div>
      <div style="text-align:center;">
        <div class="game-title-hud" id="gameNameHud">Game</div>
        <div style="font-size:11px;color:rgba(255,255,255,0.6);margin-top:3px;">–û—á–∫–∏: <span id="scoreDisplay" style="color:#ffd60a;font-weight:800;">0</span></div>
      </div>
      <button class="hud-exit" onclick="exitGame()">‚úï –í—ã—Ö–æ–¥</button>
    </div>
    <div class="hud-players">
      <div class="players-title">–ò–≥—Ä–æ–∫–∏</div>
      <div id="playersInGame"></div>
    </div>
    <div class="hud-chat" id="hudChat">
      <div class="chat-messages" id="chatMessages"></div>
      <div style="display:flex;gap:5px;">
        <input class="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." id="chatInput" onkeydown="if(event.key==='Enter')sendChat()">
        <button style="background:#ff4d6d;border:none;border-radius:7px;padding:7px 10px;color:white;cursor:pointer;font-size:14px;pointer-events:all;" onclick="sendChat()">‚û§</button>
      </div>
    </div>
    
    <!-- Mobile Controls -->
    <div class="mobile-controls" id="mobileControls">
      <div class="joystick" id="joystick">
        <div class="joystick-knob" id="joystickKnob"></div>
      </div>
      <div class="action-btns">
        <div class="action-btn" id="jumpBtn">‚¨ÜÔ∏è</div>
        <div class="action-btn" id="saveBtn">üíæ</div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// ===== DEVICE DETECTION =====
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                 ('ontouchstart' in window) || 
                 (navigator.maxTouchPoints > 0);

console.log('Device type:', isMobile ? 'Mobile' : 'Desktop');

// ===== DATABASE (localStorage) =====
const DB = {
  users: JSON.parse(localStorage.getItem('blockverse_users') || '{}'),
  init() {
    // Create admin account if not exists
    if (!this.users['daiilbv']) {
      this.users['daiilbv'] = { 
        username: 'daiilbv', 
        email: 'admin@blockverse.com', 
        password: 'daniil2016', 
        level: 99, 
        isAdmin: true,
        createdAt: Date.now() 
      };
      localStorage.setItem('blockverse_users', JSON.stringify(this.users));
    }
  },
  saveUser(username, email, password) {
    this.users[username.toLowerCase()] = { username, email, password, level: 1, createdAt: Date.now() };
    localStorage.setItem('blockverse_users', JSON.stringify(this.users));
  },
  getUser(username) {
    return this.users[username.toLowerCase()];
  },
  validateLogin(username, password) {
    const user = this.getUser(username);
    return user && user.password === password;
  }
};

// Initialize admin
DB.init();

// ===== GAME DATA =====
const GAMES = [
  {name:'Treasure Island',players:'15,284',emoji:'üèùÔ∏è',color:'#006064,#00838f',badge:'üî•',genre:'–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ',type:'adventure'},
  {name:'Neon Racer',players:'12,190',emoji:'üèéÔ∏è',color:'#b71c1c,#d32f2f',badge:'üëë',genre:'–ì–æ–Ω–∫–∏',type:'racing'},
  {name:'Dragon Quest',players:'9,445',emoji:'üêâ',color:'#1b5e20,#388e3c',badge:null,genre:'–†–ü–ì',type:'rpg'},
  {name:'Sky Parkour',players:'8,122',emoji:'üèîÔ∏è',color:'#4a148c,#7b1fa2',badge:null,genre:'–ü–∞—Ä–∫—É—Ä',type:'parkour'},
  {name:'Castle Wars',players:'7,003',emoji:'üè∞',color:'#e65100,#f57c00',badge:null,genre:'PVP',type:'pvp'},
  {name:'Space Station',players:'5,889',emoji:'üöÄ',color:'#01579b,#0277bd',badge:null,genre:'–°–∏–º—É–ª—è—Ç–æ—Ä',type:'space'},
  {name:'Pizza Tycoon',players:'6,234',emoji:'üçï',color:'#e65100,#ff6f00',badge:null,genre:'–ë–∏–∑–Ω–µ—Å',type:'tycoon'},
  {name:'Horror Mansion',players:'4,556',emoji:'üëª',color:'#212121,#424242',badge:null,genre:'–•–æ—Ä—Ä–æ—Ä',type:'horror'},
  {name:'Dance Battle',players:'3,998',emoji:'üíÉ',color:'#c2185b,#e91e63',badge:null,genre:'–†–∏—Ç–º',type:'rhythm'},
  {name:'Zombie Survival',players:'5,441',emoji:'üßü',color:'#33691e,#689f38',badge:'üÜï',genre:'–í—ã–∂–∏–≤–∞–Ω–∏–µ',type:'survival'},
];
const NEW_GAMES = [
  {name:'Magic Academy',players:'892',emoji:'üîÆ',color:'#4a148c,#7b1fa2',badge:'üÜï',genre:'–†–ü–ì',type:'rpg'},
  {name:'Skate Park Pro',players:'654',emoji:'üõπ',color:'#ff6f00,#ff8f00',badge:'üÜï',genre:'–°–ø–æ—Ä—Ç',type:'sports'},
  {name:'Ocean Explorer',players:'1,123',emoji:'üåä',color:'#006064,#00838f',badge:'üÜï',genre:'–°–∏–º—É–ª—è—Ç–æ—Ä',type:'ocean'},
  {name:'Ninja Warriors',players:'2,344',emoji:'ü•∑',color:'#212121,#424242',badge:'üÜï',genre:'–≠–∫—à–µ–Ω',type:'action'},
  {name:'City Builder',players:'1,876',emoji:'üèôÔ∏è',color:'#455a64,#607d8b',badge:'üÜï',genre:'–°—Ç—Ä–∞—Ç–µ–≥–∏—è',type:'strategy'},
  {name:'Pet Paradise',players:'567',emoji:'üê∂',color:'#f06292,#ec407a',badge:'üÜï',genre:'–°–∏–º—É–ª—è—Ç–æ—Ä',type:'pets'},
];
const FRIENDS = [
  {name:'ProGamer_X',status:'–í –∏–≥—Ä–µ: Treasure Island',online:true,emoji:'ü¶ä'},
  {name:'CoolDev_99',status:'–í —Å—Ç—É–¥–∏–∏',online:true,emoji:'üê∫'},
  {name:'StarPlayer',status:'–í –∏–≥—Ä–µ: Neon Racer',online:true,emoji:'ü¶Å'},
  {name:'BuildMaster',status:'–ù–µ –≤ —Å–µ—Ç–∏',online:false,emoji:'üêª'},
  {name:'NightOwl',status:'–ù–µ –≤ —Å–µ—Ç–∏',online:false,emoji:'ü¶Ö'},
];
const SKINS = ['#FDDBB4','#F1C27D','#E8B89E','#D4956A','#C68642','#A0522D','#8D5524','#5C3317'];
const SHIRTS = [
  {name:'–ë–∞–∑–æ–≤–∞—è',emoji:'üëï'},{name:'–ü–æ–ª–æ—Å–∫–∞',emoji:'üîµ'},{name:'–û–≥–æ–Ω—å',emoji:'üî•'},
  {name:'–ó–≤—ë–∑–¥—ã',emoji:'‚≠ê'},{name:'–ö–∞–º—É—Ñ–ª—è–∂',emoji:'üü¢'},{name:'–†–∞–¥—É–≥–∞',emoji:'üåà'},
];
const PANTS = [
  {name:'–î–∂–∏–Ω—Å—ã',emoji:'üëñ'},{name:'–®–æ—Ä—Ç—ã',emoji:'ü©≥'},{name:'–ë—Ä—é–∫–∏',emoji:'üîµ'},
  {name:'–ö–ª–µ—Ç–∫–∞',emoji:'üü®'},{name:'–ö–∞–º—É—Ñ–ª—è–∂',emoji:'üü©'},{name:'–ö–æ–∂–∞',emoji:'‚ö´'},
];
const HAIRS = [
  {name:'–ù–µ—Ç',emoji:'üòê'},{name:'–ö–æ—Ä–æ—Ç–∫–∏–µ',emoji:'üíá'},{name:'–î–ª–∏–Ω–Ω—ã–µ',emoji:'üë±'},
  {name:'–ö—É–¥—Ä–∏',emoji:'ü¶±'},{name:'–ò—Ä–æ–∫–µ–∑',emoji:'ü§ò'},{name:'–ö–æ—Ä–æ–Ω–∞',emoji:'üëë'},
];
const ACCS = [
  {name:'–ù–µ—Ç',emoji:'‚ùå'},{name:'–û—á–∫–∏',emoji:'üëì'},{name:'–ö—Ä—ã–ª—å—è',emoji:'ü¶ã'},
  {name:'–ú–µ—á',emoji:'‚öîÔ∏è'},{name:'–©–∏—Ç',emoji:'üõ°Ô∏è'},{name:'–†—é–∫–∑–∞–∫',emoji:'üéí'},
];
const COLORS = ['#ff4d6d','#ff6b35','#ffd60a','#06d6a0','#4fc3f7','#7c3aed','#ec407a','#ffffff','#9e9e9e','#37474f'];

// ===== STATE =====
let currentUser = null;
let savedGames = new Set();
let gameScene, gameCamera, gameRenderer, player, animId;
let avatarScene, avatarCamera, avatarRenderer, avatarMesh;
let studioScene, studioCamera, studioRenderer, studioBlocks = [];
let avatarState = { skin: '#FDDBB4', shirt: 0, pants: 0, hair: 0, acc: 0 };
let selectedColor = '#4fc3f7';
let score = 0, chatHistory = [];
let keys = {}, playerY = 0, playerVY = 0, playerPos = { x: 0, z: 0 };
let yaw = 0, pitch = 0;
let joystickActive = false, joystickVector = { x: 0, y: 0 };
let currentGameData = null;

// ===== APPLY MOBILE STYLES =====
function applyMobileStyles() {
  if (isMobile) {
    document.getElementById('menuSidebar').classList.add('mobile-hide');
    document.getElementById('mobileNav').classList.add('mobile-show');
    document.getElementById('homeWrap').classList.add('mobile-padding');
    document.getElementById('homeBanner').classList.add('mobile-padding');
    document.getElementById('bannerTitle').classList.add('mobile-size');
    document.querySelectorAll('.games-grid').forEach(g => g.classList.add('mobile-grid'));
    document.getElementById('friendsWrap').classList.add('mobile-padding');
    document.getElementById('studioLeft').classList.add('mobile-hide');
    document.getElementById('studioRight').classList.add('mobile-hide');
    document.getElementById('avatarWrap').classList.add('mobile-style');
    document.getElementById('avatarPreview').classList.add('mobile-full');
    document.querySelectorAll('.skin-grid').forEach(g => g.classList.add('mobile-grid'));
    document.querySelectorAll('.items-grid').forEach(g => g.classList.add('mobile-grid'));
    document.getElementById('hudChat').classList.add('mobile-size');
    document.getElementById('mobileControls').classList.add('mobile-show');
  }
}

// ===== AUTH =====
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(tab + 'Form').classList.add('active');
  hideError();
}

function showError(msg) {
  const err = document.getElementById('authError');
  err.textContent = msg;
  err.classList.add('show');
}

function hideError() {
  document.getElementById('authError').classList.remove('show');
}

function handleLogin(e) {
  e.preventDefault();
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;
  
  if (DB.validateLogin(username, password)) {
    const user = DB.getUser(username);
    currentUser = user.username;
    document.getElementById('playerNameDisplay').textContent = currentUser;
    document.getElementById('avatarNameDisplay').textContent = currentUser;
    document.getElementById('playerLevel').textContent = `–£—Ä–æ–≤–µ–Ω—å ${user.level}${user.isAdmin?' üëë':''}`;
    startLoading();
  } else {
    showError('‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
  }
  return false;
}

function handleRegister(e) {
  e.preventDefault();
  const username = document.getElementById('regUsername').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const password = document.getElementById('regPassword').value;
  const passwordConfirm = document.getElementById('regPasswordConfirm').value;
  
  if (username.length < 3) {
    showError('‚ùå –ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞');
    return false;
  }
  
  if (DB.getUser(username)) {
    showError('‚ùå –≠—Ç–æ –∏–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ');
    return false;
  }
  
  if (password.length < 6) {
    showError('‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
    return false;
  }
  
  if (password !== passwordConfirm) {
    showError('‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
    return false;
  }
  
  DB.saveUser(username, email, password);
  currentUser = username;
  document.getElementById('playerNameDisplay').textContent = currentUser;
  document.getElementById('avatarNameDisplay').textContent = currentUser;
  document.getElementById('playerLevel').textContent = '–£—Ä–æ–≤–µ–Ω—å 1';
  startLoading();
  return false;
}

// ===== LOADING =====
function startLoading() {
  document.getElementById('authScreen').classList.remove('active');
  document.getElementById('loadingScreen').classList.add('active');
  loadSavedData();
  fakeLoad();
}

function fakeLoad() {
  const bar = document.getElementById('loadBar');
  const txt = document.getElementById('loadText');
  const msgs = ['–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç—É—Ä...','–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è 3D –¥–≤–∏–∂–∫–∞...','–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä–∞–º...','–ó–∞–≥—Ä—É–∑–∫–∞ –¥—Ä—É–∑–µ–π...','–ì–æ—Ç–æ–≤–æ!'];
  let p = 0;
  const iv = setInterval(() => {
    p += Math.random() * 15 + 8;
    if(p >= 100) { p = 100; clearInterval(iv); setTimeout(showMenu, 300); }
    bar.style.width = p + '%';
    txt.textContent = msgs[Math.floor(p/25)] || msgs[msgs.length-1];
  }, 160);
}

function showMenu() {
  document.getElementById('loadingScreen').classList.remove('active');
  document.getElementById('mainMenu').classList.add('active');
  applyMobileStyles();
  buildUI();
  initAvatar();
  initStudio();
}

// ===== BUILD UI =====
function buildUI() {
  buildGamesGrid('gamesGrid', GAMES);
  buildGamesGrid('newGamesGrid', NEW_GAMES);
  
  const fl = document.getElementById('friendList');
  fl.innerHTML = '';
  FRIENDS.forEach(f=>{
    const el=document.createElement('div');
    el.className='friend-item';
    el.innerHTML=`
      <div class="friend-ava" style="background:linear-gradient(135deg,${f.online?'#ff4d6d,#c02045':'#333,#555'})">${f.emoji}
        <div class="online-dot ${f.online?'':'offline'}"></div>
      </div>
      <div class="friend-info">
        <div class="friend-name">${f.name}</div>
        <div class="friend-status">${f.status}</div>
      </div>
    `;
    fl.appendChild(el);
  });
  
  const sg=document.getElementById('skinGrid');
  sg.innerHTML = '';
  SKINS.forEach((s,i)=>{
    const sw=document.createElement('div');
    sw.className='skin-swatch'+(i===0?' active':'');
    sw.style.background=s;
    sw.onclick=()=>{ avatarState.skin=s; document.querySelectorAll('.skin-swatch').forEach(x=>x.classList.remove('active')); sw.classList.add('active'); updateAvatarColors(); saveAvatarState(); };
    sg.appendChild(sw);
  });
  buildItemGrid('shirtGrid', SHIRTS, 'shirt');
  buildItemGrid('pantsGrid', PANTS, 'pants');
  buildItemGrid('hairGrid', HAIRS, 'hair');
  buildItemGrid('accGrid', ACCS, 'acc');
  
  const sc = document.getElementById('studioColors');
  sc.innerHTML = '';
  COLORS.forEach(c=>{
    const sw=document.createElement('div');
    sw.className='color-swatch'+(c===selectedColor?' active':'');
    sw.style.background=c;
    sw.onclick=()=>{ selectedColor=c; document.querySelectorAll('#studioColors .color-swatch').forEach(s=>s.classList.remove('active')); sw.classList.add('active'); };
    sc.appendChild(sw);
  });
}

function buildGamesGrid(id, games) {
  const g = document.getElementById(id);
  g.innerHTML = '';
  games.forEach(game=>{
    const isSaved = savedGames.has(game.name);
    const card=document.createElement('div');
    card.className='game-card';
    card.onclick=()=>launchGame(game);
    card.innerHTML=`
      <div class="game-thumb">
        <div class="game-thumb-bg" style="background:linear-gradient(135deg,${game.color})"></div>
        <span style="position:relative;font-size:40px;">${game.emoji}</span>
        ${game.badge?`<div class="game-badge">${game.badge}</div>`:''}
        ${isSaved?`<div class="saved-indicator">üíæ</div>`:''}
      </div>
      <div class="game-info">
        <div class="game-name">${game.name}</div>
        <div class="game-players">‚óè ${game.players} –∏–≥—Ä–∞—é—Ç</div>
        <div class="game-genre">${game.genre}</div>
      </div>
    `;
    g.appendChild(card);
  });
}

function buildItemGrid(id, items, type) {
  const g = document.getElementById(id);
  g.innerHTML = '';
  items.forEach((item,i)=>{
    const card=document.createElement('div');
    card.className='item-card'+(i===0?' selected':'');
    card.innerHTML=`<div class="item-icon">${item.emoji}</div><div class="item-name">${item.name}</div>`;
    card.onclick=()=>{
      avatarState[type]=i;
      document.querySelectorAll(`#${id} .item-card`).forEach(c=>c.classList.remove('selected'));
      card.classList.add('selected');
      updateAvatarColors();
      saveAvatarState();
    };
    g.appendChild(card);
  });
}

// ===== TAB SWITCHING =====
function switchTab(tab) {
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.menu-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.mobile-nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('active');
  const desktopBtn = document.getElementById('btn'+tab.charAt(0).toUpperCase()+tab.slice(1));
  if(desktopBtn) desktopBtn.classList.add('active');
  document.querySelectorAll('.mobile-nav-btn').forEach(b=>{
    if(b.textContent.toLowerCase().includes(tab.substring(0,4))) b.classList.add('active');
  });
  if(tab==='studio') { setTimeout(()=>{ resizeStudio(); renderStudio(); }, 100); }
  if(tab==='avatar') { setTimeout(()=>{ resizeAvatar(); }, 100); }
}

// ===== SAVE/LOAD =====
function loadSavedData() {
  const saved = localStorage.getItem('blockverse_saved_games_' + currentUser);
  if(saved) savedGames = new Set(JSON.parse(saved));
  
  const avatarSaved = localStorage.getItem('blockverse_avatar_' + currentUser);
  if(avatarSaved) {
    avatarState = JSON.parse(avatarSaved);
    setTimeout(() => {
      document.querySelectorAll('.skin-swatch').forEach((s,i)=>{ s.classList.toggle('active',SKINS[i]===avatarState.skin); });
      ['shirtGrid','pantsGrid','hairGrid','accGrid'].forEach((id,idx)=>{
        const key=['shirt','pants','hair','acc'][idx];
        document.querySelectorAll(`#${id} .item-card`).forEach((c,i)=>c.classList.toggle('selected',i===avatarState[key]));
      });
    }, 100);
  }
}

function saveGame(gameName) {
  savedGames.add(gameName);
  localStorage.setItem('blockverse_saved_games_' + currentUser, JSON.stringify([...savedGames]));
  showNotif(`üíæ –ò–≥—Ä–∞ "${gameName}" —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!`);
  buildGamesGrid('gamesGrid', GAMES);
  buildGamesGrid('newGamesGrid', NEW_GAMES);
}

function saveAvatarState() {
  localStorage.setItem('blockverse_avatar_' + currentUser, JSON.stringify(avatarState));
}

function showNotif(text) {
  const n = document.createElement('div');
  n.style.cssText = 'position:fixed;top:16px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#06d6a0,#059669);color:white;padding:10px 22px;border-radius:99px;font-weight:800;font-size:13px;z-index:9999;animation:slideIn 0.3s;box-shadow:0 4px 16px rgba(0,0,0,0.3);';
  n.textContent = text;
  document.body.appendChild(n);
  setTimeout(()=>{
    n.style.animation = 'slideOut 0.3s';
    setTimeout(()=>n.remove(), 300);
  }, 2000);
}

// ===== AVATAR 3D (IMPROVED CHARACTER) =====
function initAvatar() {
  const canvas = document.getElementById('avatarCanvas');
  avatarScene = new THREE.Scene();
  avatarCamera = new THREE.PerspectiveCamera(50, 200/260, 0.1, 100);
  avatarCamera.position.set(0, 2, 7);
  avatarCamera.lookAt(0, 1.5, 0);
  avatarRenderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
  avatarRenderer.setSize(200, 260);
  avatarRenderer.setClearColor(0x000000, 0);
  
  avatarScene.add(new THREE.AmbientLight(0xffffff, 1));
  const dl=new THREE.DirectionalLight(0xffffff, 1.4);
  dl.position.set(4,7,5); avatarScene.add(dl);
  const dl2=new THREE.DirectionalLight(0x7c3aed,0.6);
  dl2.position.set(-4,4,-4); avatarScene.add(dl2);
  
  buildAvatarMesh();
  animAvatar();
}

function buildAvatarMesh() {
  if(avatarMesh) avatarScene.remove(avatarMesh);
  const g = new THREE.Group();
  const skinC = new THREE.Color(avatarState.skin);
  const shirtC = [0xff4d6d,0x4fc3f7,0xff6b35,0xffd60a,0x7c3aed,0xff69b4][avatarState.shirt%6];
  const pantsC = [0x1565c0,0xff8c00,0x333355,0xffd60a,0x2e7d32,0x222222][avatarState.pants%6];
  const m = (c)=>new THREE.MeshLambertMaterial({color:c});
  
  // Better proportioned body
  const torso=new THREE.Mesh(new THREE.BoxGeometry(1.3,1.6,0.7),m(shirtC));
  torso.position.y=1.8; g.add(torso);
  
  // Head with better size
  const head=new THREE.Mesh(new THREE.BoxGeometry(1.1,1.1,1.1),m(skinC));
  head.position.y=3; g.add(head);
  
  // Eyes with depth
  const eyeWhiteL=new THREE.Mesh(new THREE.BoxGeometry(0.3,0.3,0.08),m(0xffffff));
  eyeWhiteL.position.set(-0.3,3.05,0.56); g.add(eyeWhiteL);
  const eyeWhiteR=eyeWhiteL.clone(); eyeWhiteR.position.x=0.3; g.add(eyeWhiteR);
  
  const pupilL=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.18,0.08),m(0x0a0a0a));
  pupilL.position.set(-0.3,3.05,0.57); g.add(pupilL);
  const pupilR=pupilL.clone(); pupilR.position.x=0.3; g.add(pupilR);
  
  // Better smile
  const smile=new THREE.Mesh(new THREE.BoxGeometry(0.6,0.12,0.08),m(0x8d4004));
  smile.position.set(0,2.7,0.56); g.add(smile);
  
  // Hair styles
  if(avatarState.hair>0&&avatarState.hair<4) {
    const hc=[0,0x2c1503,0xffd700,0xff4500][avatarState.hair]||0x2c1503;
    const hair=new THREE.Mesh(new THREE.BoxGeometry(1.2,0.4,1.2),m(hc));
    hair.position.y=3.5; g.add(hair);
  }
  if(avatarState.hair===4) {
    const mohawk=new THREE.Mesh(new THREE.BoxGeometry(0.35,0.7,1),m(0xff4500));
    mohawk.position.y=3.65; g.add(mohawk);
  }
  if(avatarState.hair===5) {
    const crown=new THREE.Mesh(new THREE.CylinderGeometry(0.6,0.6,0.35,8),m(0xffd700));
    crown.position.y=3.6; g.add(crown);
    for(let i=0;i<8;i++){
      const spike=new THREE.Mesh(new THREE.ConeGeometry(0.15,0.4,4),m(0xffd700));
      const ang=i*Math.PI/4;
      spike.position.set(Math.cos(ang)*0.5,3.9,Math.sin(ang)*0.5);
      g.add(spike);
    }
  }
  
  // Legs with shoes
  const legL=new THREE.Mesh(new THREE.BoxGeometry(0.55,1.4,0.55),m(pantsC));
  legL.position.set(-0.4,0.7,0); g.add(legL);
  const legR=legL.clone(); legR.position.x=0.4; g.add(legR);
  
  const shoeL=new THREE.Mesh(new THREE.BoxGeometry(0.6,0.3,0.8),m(0x1a1a1a));
  shoeL.position.set(-0.4,0.15,0.15); g.add(shoeL);
  const shoeR=shoeL.clone(); shoeR.position.x=0.4; g.add(shoeR);
  
  // Arms
  const armL=new THREE.Mesh(new THREE.BoxGeometry(0.45,1.4,0.45),m(skinC));
  armL.position.set(-0.95,1.8,0); g.add(armL);
  const armR=armL.clone(); armR.position.x=0.95; g.add(armR);
  
  // Accessories
  if(avatarState.acc===1) {
    const gl=new THREE.Mesh(new THREE.TorusGeometry(0.18,0.04,8,16),m(0x111111));
    gl.position.set(-0.3,3.05,0.6); gl.rotation.y=Math.PI/2; g.add(gl);
    const gr=gl.clone(); gr.position.x=0.3; g.add(gr);
    const bridge=new THREE.Mesh(new THREE.BoxGeometry(0.4,0.04,0.04),m(0x111111));
    bridge.position.set(0,3.05,0.6); g.add(bridge);
  }
  if(avatarState.acc===2) {
    const wingL=new THREE.Mesh(new THREE.BoxGeometry(0.12,1,1.5),m(0x9c27b0));
    wingL.position.set(-0.8,2.3,0); wingL.rotation.y=-Math.PI/5; g.add(wingL);
    const wingR=wingL.clone(); wingR.position.x=0.8; wingR.rotation.y=Math.PI/5; g.add(wingR);
  }
  if(avatarState.acc===3) {
    const sword=new THREE.Mesh(new THREE.BoxGeometry(0.1,1.8,0.1),m(0xcccccc));
    sword.position.set(1.4,1.8,0); sword.rotation.z=-Math.PI/5; g.add(sword);
    const handle=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.4,0.15),m(0x8d4004));
    handle.position.set(1.25,1.1,0); handle.rotation.z=-Math.PI/5; g.add(handle);
    const guard=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.08,0.08),m(0xffd700));
    guard.position.set(1.3,1.3,0); guard.rotation.z=-Math.PI/5; g.add(guard);
  }
  if(avatarState.acc===4) {
    const shield=new THREE.Mesh(new THREE.BoxGeometry(0.1,1.2,1),m(0xff4d6d));
    shield.position.set(-1.2,1.8,0); g.add(shield);
    const emblem=new THREE.Mesh(new THREE.BoxGeometry(0.11,0.4,0.4),m(0xffd700));
    emblem.position.set(-1.21,1.8,0); g.add(emblem);
  }
  if(avatarState.acc===5) {
    const pack=new THREE.Mesh(new THREE.BoxGeometry(0.9,1,0.5),m(0x2e7d32));
    pack.position.set(0,2.2,-0.6); g.add(pack);
    const strapL=new THREE.Mesh(new THREE.BoxGeometry(0.1,1,0.1),m(0x1a5e20));
    strapL.position.set(-0.3,2.2,0); g.add(strapL);
    const strapR=strapL.clone(); strapR.position.x=0.3; g.add(strapR);
  }
  
  g.position.y=-1.5;
  avatarMesh=g;
  avatarScene.add(g);
}

function updateAvatarColors() { buildAvatarMesh(); }

function randomizeAvatar() {
  avatarState.skin=SKINS[Math.floor(Math.random()*SKINS.length)];
  avatarState.shirt=Math.floor(Math.random()*SHIRTS.length);
  avatarState.pants=Math.floor(Math.random()*PANTS.length);
  avatarState.hair=Math.floor(Math.random()*HAIRS.length);
  avatarState.acc=Math.floor(Math.random()*ACCS.length);
  
  document.querySelectorAll('.skin-swatch').forEach((s,i)=>{ s.classList.toggle('active',SKINS[i]===avatarState.skin); });
  ['shirtGrid','pantsGrid','hairGrid','accGrid'].forEach((id,idx)=>{
    const key=['shirt','pants','hair','acc'][idx];
    document.querySelectorAll(`#${id} .item-card`).forEach((c,i)=>c.classList.toggle('selected',i===avatarState[key]));
  });
  buildAvatarMesh();
  saveAvatarState();
}

function animAvatar() {
  function loop() {
    requestAnimationFrame(loop);
    if(avatarMesh) avatarMesh.rotation.y+=0.007;
    avatarRenderer.render(avatarScene, avatarCamera);
  }
  loop();
}

function resizeAvatar() {
  const wrap=document.querySelector('.avatar-3d-wrap');
  if(!wrap||!avatarRenderer) return;
  avatarRenderer.setSize(wrap.clientWidth, wrap.clientHeight);
  avatarCamera.aspect=wrap.clientWidth/wrap.clientHeight;
  avatarCamera.updateProjectionMatrix();
}

// ===== STUDIO =====
function initStudio() {
  const canvas = document.getElementById('studioCanvas');
  studioScene = new THREE.Scene();
  studioScene.background = new THREE.Color(0x0a0e1a);
  studioCamera = new THREE.PerspectiveCamera(60, 1, 0.1, 200);
  studioCamera.position.set(10, 10, 15);
  studioCamera.lookAt(0, 0, 0);
  studioRenderer = new THREE.WebGLRenderer({ canvas, antialias: true });
  studioRenderer.shadowMap.enabled = true;
  
  studioScene.add(new THREE.AmbientLight(0x334466, 0.8));
  const dir = new THREE.DirectionalLight(0xffffff, 1.2);
  dir.position.set(15, 25, 15);
  dir.castShadow = true;
  studioScene.add(dir);
  
  const grid = new THREE.GridHelper(50, 50, 0x333355, 0x1c2138);
  studioScene.add(grid);
  
  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(50, 50),
    new THREE.MeshLambertMaterial({ color: 0x0a0e1a })
  );
  ground.rotation.x = -Math.PI/2;
  ground.receiveShadow = true;
  studioScene.add(ground);
  
  addStudioBlock(0,0,0,'#06d6a0',2,1,2);
  addStudioBlock(3,0,0,'#ff4d6d');
  addStudioBlock(-3,0,0,'#7c3aed');
  
  resizeStudio();
  
  let drag=false, mx=0, my=0;
  canvas.addEventListener('mousedown',e=>{ drag=true; mx=e.clientX; my=e.clientY; });
  document.addEventListener('mouseup',()=>drag=false);
  document.addEventListener('mousemove',e=>{
    if(!drag) return;
    const dx=e.clientX-mx, dy=e.clientY-my;
    studioCamera.position.x += dx * 0.05;
    studioCamera.position.y -= dy * 0.05;
    studioCamera.lookAt(0,0,0);
    mx=e.clientX; my=e.clientY;
  });
}

function addStudioBlock(x,y,z,col='#4fc3f7',w=1,h=1,d=1) {
  const mesh = new THREE.Mesh(
    new THREE.BoxGeometry(w,h,d),
    new THREE.MeshLambertMaterial({ color: new THREE.Color(col) })
  );
  mesh.position.set(x,y+h/2,z);
  mesh.castShadow=true; mesh.receiveShadow=true;
  studioScene.add(mesh);
  studioBlocks.push(mesh);
  updateObjList();
}

function updateObjList() {
  const list=document.getElementById('objList');
  list.innerHTML='<div style="padding:7px;font-size:11px;font-weight:700;color:var(--text2);">üåç World</div>';
  studioBlocks.forEach((b,i)=>{
    const el=document.createElement('div');
    el.style.cssText='padding:7px;font-size:11px;font-weight:600;cursor:pointer;border-radius:6px;margin-bottom:3px;';
    el.textContent=`üß± Block ${i+1}`;
    el.onmouseover=()=>el.style.background='rgba(255,255,255,0.05)';
    el.onmouseout=()=>el.style.background='transparent';
    list.appendChild(el);
  });
}

function setTool(t) {
  document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
}

function clearStudio() {
  studioBlocks.forEach(b=>studioScene.remove(b));
  studioBlocks=[]; updateObjList();
}

function testPlay() {
  const testGame = {name:'–ú–æ—è –∏–≥—Ä–∞ (—Ç–µ—Å—Ç)',players:'1',emoji:'üéÆ',color:'#ff4d6d,#c02045',type:'custom',genre:'–¢–µ—Å—Ç'};
  launchGame(testGame);
}

function publishStudioGame() {
  const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã:') || '–ú–æ—è –∏–≥—Ä–∞';
  showNotif(`üöÄ –ò–≥—Ä–∞ "${name}" –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!`);
}

function renderStudio() {
  requestAnimationFrame(renderStudio);
  studioRenderer.render(studioScene, studioCamera);
}

function resizeStudio() {
  const wrap=document.querySelector('.studio-canvas-wrap');
  if(!wrap||!studioRenderer) return;
  studioRenderer.setSize(wrap.clientWidth, wrap.clientHeight);
  studioCamera.aspect=wrap.clientWidth/wrap.clientHeight;
  studioCamera.updateProjectionMatrix();
}

// ===== GAME ENGINE (DIVERSE WORLDS) =====
function launchRandomGame() {
  const allGames = [...GAMES, ...NEW_GAMES];
  launchGame(allGames[Math.floor(Math.random()*allGames.length)]);
}

function launchGame(game) {
  currentGameData = game;
  document.getElementById('mainMenu').classList.remove('active');
  document.getElementById('gameScreen').classList.add('active');
  document.getElementById('gameNameHud').textContent=game.name;
  score=0; document.getElementById('scoreDisplay').textContent=0;
  buildGameWorld(game);
  setupGameInput();
  setupMobileControls();
  initChat(game.name);
  populateGamePlayers();
}

function buildGameWorld(game) {
  const canvas=document.getElementById('gameCanvas');
  if(gameRenderer) { cancelAnimationFrame(animId); gameRenderer.dispose(); }
  
  gameScene=new THREE.Scene();
  
  // UNIQUE environments per type
  const envConfig = {
    adventure: { bg: 0x87CEEB, fog: [0x87CEEB, 30, 80], ground: 0xc2b280 },
    racing: { bg: 0x1a0533, fog: [0x1a0533, 25, 60], ground: 0x2a2a3e },
    rpg: { bg: 0x2a3d2a, fog: [0x2a3d2a, 30, 70], ground: 0x3a5a3a },
    parkour: { bg: 0x87CEEB, fog: [0x87CEEB, 40, 100], ground: 0x8a9a8a },
    pvp: { bg: 0x4a2a2a, fog: [0x4a2a2a, 30, 70], ground: 0x5a3a3a },
    space: { bg: 0x000011, fog: [0x000011, 50, 150], ground: 0x1a1a2e },
    tycoon: { bg: 0xffd6a5, fog: [0xffd6a5, 30, 70], ground: 0x8d5524 },
    horror: { bg: 0x0a0a0a, fog: [0x000000, 15, 40], ground: 0x1a1a1a },
    rhythm: { bg: 0xff1493, fog: [0xff1493, 25, 60], ground: 0x2a1a2a },
    survival: { bg: 0x2a4d2a, fog: [0x2a4d2a, 25, 65], ground: 0x3a5a3a },
    sports: { bg: 0x4fc3f7, fog: [0x4fc3f7, 30, 75], ground: 0x7a9a7a },
    ocean: { bg: 0x006994, fog: [0x006994, 35, 80], ground: 0x1a4a6a },
    action: { bg: 0x1a1a2e, fog: [0x1a1a2e, 25, 60], ground: 0x2a2a3e },
    strategy: { bg: 0x607d8b, fog: [0x607d8b, 30, 70], ground: 0x455a64 },
    pets: { bg: 0xffccf9, fog: [0xffccf9, 30, 70], ground: 0xf8bbd0 },
    custom: { bg: 0x0a0e1a, fog: [0x0a0e1a, 30, 70], ground: 0x1c2138 }
  };
  
  const env = envConfig[game.type] || envConfig.custom;
  gameScene.background = new THREE.Color(env.bg);
  gameScene.fog = new THREE.Fog(env.fog[0], env.fog[1], env.fog[2]);
  
  gameCamera=new THREE.PerspectiveCamera(75, canvas.clientWidth/canvas.clientHeight, 0.1, 200);
  gameCamera.position.set(0,5,0);
  gameRenderer=new THREE.WebGLRenderer({canvas,antialias:true});
  gameRenderer.setSize(canvas.clientWidth, canvas.clientHeight);
  gameRenderer.shadowMap.enabled=true;
  
  gameScene.add(new THREE.AmbientLight(0xffffff,game.type==='horror'?0.25:0.65));
  const sun=new THREE.DirectionalLight(0xffffff,game.type==='horror'?0.4:1.1);
  sun.position.set(25,50,25); sun.castShadow=true;
  gameScene.add(sun);
  
  const ground=new THREE.Mesh(
    new THREE.PlaneGeometry(100,100),
    new THREE.MeshLambertMaterial({color:env.ground})
  );
  ground.rotation.x=-Math.PI/2; ground.receiveShadow=true;
  gameScene.add(ground);
  
  // DIVERSE world generation
  if(game.type === 'racing') {
    for(let i=0;i<30;i++){
      const barrier=new THREE.Mesh(
        new THREE.CylinderGeometry(0.3,0.3,2.5,8),
        new THREE.MeshLambertMaterial({color:i%2===0?0xff4d6d:0xffd60a})
      );
      const ang=i*0.21;
      barrier.position.set(Math.cos(ang)*18,1.25,Math.sin(ang)*18);
      barrier.castShadow=true;
      gameScene.add(barrier);
    }
  } else if(game.type === 'horror') {
    for(let i=0;i<12;i++){
      const wall=new THREE.Mesh(
        new THREE.BoxGeometry(3,4,0.3),
        new THREE.MeshLambertMaterial({color:0x1a1a1a})
      );
      const ang=i*Math.PI/6;
      wall.position.set(Math.cos(ang)*15,2,Math.sin(ang)*15);
      wall.lookAt(0,2,0);
      wall.castShadow=true;
      gameScene.add(wall);
    }
  } else if(game.type === 'rpg') {
    for(let i=0;i<8;i++){
      const tower=new THREE.Mesh(
        new THREE.CylinderGeometry(1.8,2,6,12),
        new THREE.MeshLambertMaterial({color:0x6a7a8a})
      );
      const ang=i*Math.PI/4;
      tower.position.set(Math.cos(ang)*22,3,Math.sin(ang)*22);
      tower.castShadow=true;
      gameScene.add(tower);
      
      const roof=new THREE.Mesh(
        new THREE.ConeGeometry(2.2,2,12),
        new THREE.MeshLambertMaterial({color:0x8d4004})
      );
      roof.position.set(Math.cos(ang)*22,7,Math.sin(ang)*22);
      gameScene.add(roof);
    }
  } else if(game.type === 'parkour') {
    for(let i=0;i<20;i++){
      const platform=new THREE.Mesh(
        new THREE.CylinderGeometry(1.5+Math.random(),1.5+Math.random(),0.6,16),
        new THREE.MeshLambertMaterial({color:0x4fc3f7})
      );
      const ang=Math.random()*Math.PI*2;
      const dist=8+Math.random()*18;
      platform.position.set(Math.cos(ang)*dist,2+Math.random()*8,Math.sin(ang)*dist);
      platform.castShadow=true; platform.receiveShadow=true;
      gameScene.add(platform);
    }
  } else if(game.type === 'space') {
    for(let i=0;i<10;i++){
      const module=new THREE.Mesh(
        new THREE.SphereGeometry(2,12,12),
        new THREE.MeshLambertMaterial({color:0x2a3a4a})
      );
      const ang=i*Math.PI/5;
      module.position.set(Math.cos(ang)*20,2,Math.sin(ang)*20);
      module.castShadow=true;
      gameScene.add(module);
    }
  } else if(game.type === 'tycoon') {
    for(let i=0;i<8;i++){
      const building=new THREE.Mesh(
        new THREE.BoxGeometry(4,3+Math.random()*4,4),
        new THREE.MeshLambertMaterial({color:0xf57c00})
      );
      const ang=Math.random()*Math.PI*2;
      const dist=10+Math.random()*15;
      building.position.set(Math.cos(ang)*dist,building.geometry.parameters.height/2,Math.sin(ang)*dist);
      building.castShadow=true;
      gameScene.add(building);
    }
  } else if(game.type === 'ocean') {
    for(let i=0;i<15;i++){
      const rock=new THREE.Mesh(
        new THREE.DodecahedronGeometry(1+Math.random()*2),
        new THREE.MeshLambertMaterial({color:0x3a5a6a})
      );
      const ang=Math.random()*Math.PI*2;
      const dist=8+Math.random()*20;
      rock.position.set(Math.cos(ang)*dist,-0.5+Math.random(),Math.sin(ang)*dist);
      rock.castShadow=true;
      gameScene.add(rock);
    }
  } else {
    const colors=[0xff4d6d,0x7c3aed,0x06d6a0,0xffd60a,0x4fc3f7,0xff6b35,0xec407a,0x8bc34a];
    for(let i=0;i<25;i++){
      const shapes = [
        new THREE.BoxGeometry(1+Math.random()*2,0.8+Math.random()*4,1+Math.random()*2),
        new THREE.CylinderGeometry(0.5+Math.random(),0.5+Math.random(),1+Math.random()*3,12),
        new THREE.SphereGeometry(0.5+Math.random()*1.5,12,12),
        new THREE.ConeGeometry(0.5+Math.random(),1+Math.random()*2,8)
      ];
      const mesh=new THREE.Mesh(
        shapes[Math.floor(Math.random()*shapes.length)],
        new THREE.MeshLambertMaterial({color:colors[i%colors.length]})
      );
      const ang=Math.random()*Math.PI*2;
      const dist=10+Math.random()*22;
      mesh.position.set(Math.cos(ang)*dist,mesh.geometry.parameters.height||1,Math.sin(ang)*dist);
      mesh.castShadow=true; mesh.receiveShadow=true;
      gameScene.add(mesh);
    }
  }
  
  // Collectibles
  const coinColor = game.type==='rpg'?0x7c3aed:game.type==='space'?0x4fc3f7:0xffd60a;
  for(let i=0;i<15;i++){
    const coin=new THREE.Mesh(
      new THREE.TorusGeometry(0.35,0.12,8,16),
      new THREE.MeshLambertMaterial({color:coinColor})
    );
    const ang=Math.random()*Math.PI*2;
    const dist=6+Math.random()*18;
    coin.position.set(Math.cos(ang)*dist,1.2+Math.random()*2.5,Math.sin(ang)*dist);
    coin.rotation.x=Math.PI/2;
    coin.userData.isCoin=true;
    gameScene.add(coin);
  }
  
  // IMPROVED PLAYER MODEL
  const pg=new THREE.Group();
  const torso=new THREE.Mesh(
    new THREE.BoxGeometry(0.9,1.3,0.6),
    new THREE.MeshLambertMaterial({color:new THREE.Color(avatarState.skin||'#FDDBB4')})
  );
  torso.position.y=0.65;
  const head=new THREE.Mesh(
    new THREE.BoxGeometry(0.8,0.8,0.8),
    new THREE.MeshLambertMaterial({color:new THREE.Color(avatarState.skin||'#FDDBB4')})
  );
  head.position.y=1.6;
  pg.add(torso); pg.add(head);
  
  // Eyes
  const eyeL=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.15,0.05),new THREE.MeshLambertMaterial({color:0x0a0a0a}));
  eyeL.position.set(-0.2,1.65,0.41); pg.add(eyeL);
  const eyeR=eyeL.clone(); eyeR.position.x=0.2; pg.add(eyeR);
  
  // Legs
  const legL=new THREE.Mesh(
    new THREE.BoxGeometry(0.38,1,0.38),
    new THREE.MeshLambertMaterial({color:0x1565c0})
  );
  legL.position.set(-0.25,0.5,0);
  const legR=legL.clone(); legR.position.x=0.25;
  pg.add(legL); pg.add(legR);
  
  player=pg;
  gameScene.add(player);
  playerPos={x:0,z:0}; playerY=0; playerVY=0; yaw=0;
  gameLoop();
}

function gameLoop() {
  animId=requestAnimationFrame(gameLoop);
  const spd=0.14;
  const fwd=new THREE.Vector3(-Math.sin(yaw),0,-Math.cos(yaw));
  const rgt=new THREE.Vector3(Math.cos(yaw),0,-Math.sin(yaw));
  
  if(keys['KeyW']||keys['ArrowUp']) { playerPos.x+=fwd.x*spd; playerPos.z+=fwd.z*spd; }
  if(keys['KeyS']||keys['ArrowDown']) { playerPos.x-=fwd.x*spd; playerPos.z-=fwd.z*spd; }
  if(keys['KeyA']||keys['ArrowLeft']) { playerPos.x-=rgt.x*spd; playerPos.z-=rgt.z*spd; }
  if(keys['KeyD']||keys['ArrowRight']) { playerPos.x+=rgt.x*spd; playerPos.z+=rgt.z*spd; }
  
  if(joystickActive) {
    playerPos.x += (fwd.x * joystickVector.y + rgt.x * joystickVector.x) * spd;
    playerPos.z += (fwd.z * joystickVector.y + rgt.z * joystickVector.x) * spd;
  }
  
  playerVY-=0.018;
  playerY+=playerVY;
  if(playerY<=0) { playerY=0; playerVY=0; }
  player.position.set(playerPos.x,playerY,playerPos.z);
  player.rotation.y=yaw;
  
  const camDist=7, camH=4.5;
  const cx=playerPos.x+Math.sin(yaw)*camDist, cz=playerPos.z+Math.cos(yaw)*camDist;
  gameCamera.position.lerp(new THREE.Vector3(cx,playerY+camH,cz),0.09);
  gameCamera.lookAt(playerPos.x,playerY+1.8,playerPos.z);
  
  gameScene.children.filter(c=>c.userData&&c.userData.isCoin).forEach(coin=>{
    coin.rotation.z+=0.05;
    if(player.position.distanceTo(coin.position)<1.8){
      gameScene.remove(coin);
      score+=10;
      document.getElementById('scoreDisplay').textContent=score;
      coin.userData.isCoin=false;
    }
  });
  
  gameRenderer.render(gameScene,gameCamera);
}

function setupGameInput() {
  document.addEventListener('keydown',e=>{
    keys[e.code]=true;
    if(e.code==='Space'&&playerY===0){ playerVY=0.32; e.preventDefault(); }
    if(e.code==='Escape') exitGame();
  });
  document.addEventListener('keyup',e=>keys[e.code]=false);
  const canvas=document.getElementById('gameCanvas');
  canvas.addEventListener('click',()=>{ if(document.pointerLockElement!==canvas) canvas.requestPointerLock(); });
  document.addEventListener('pointerlockchange',()=>{
    const locked=document.pointerLockElement===canvas;
    if(!locked) keys={};
  });
  document.addEventListener('mousemove',e=>{
    if(document.pointerLockElement!==canvas) return;
    yaw-=e.movementX*0.0025;
  });
  window.addEventListener('resize',()=>{
    const c=document.getElementById('gameCanvas');
    if(gameRenderer) {
      gameRenderer.setSize(c.clientWidth,c.clientHeight);
      gameCamera.aspect=c.clientWidth/c.clientHeight;
      gameCamera.updateProjectionMatrix();
    }
  });
}

function setupMobileControls() {
  const joystick = document.getElementById('joystick');
  const knob = document.getElementById('joystickKnob');
  const jumpBtn = document.getElementById('jumpBtn');
  const saveBtn = document.getElementById('saveBtn');
  
  let touchId = null;
  let centerX = 0, centerY = 0;
  
  joystick.addEventListener('touchstart', e => {
    e.preventDefault();
    const touch = e.touches[0];
    touchId = touch.identifier;
    const rect = joystick.getBoundingClientRect();
    centerX = rect.left + rect.width/2;
    centerY = rect.top + rect.height/2;
    joystickActive = true;
  });
  
  document.addEventListener('touchmove', e => {
    if(!joystickActive || touchId === null) return;
    const touch = Array.from(e.touches).find(t => t.identifier === touchId);
    if(!touch) return;
    
    const dx = touch.clientX - centerX;
    const dy = touch.clientY - centerY;
    const distance = Math.min(Math.sqrt(dx*dx + dy*dy), 32);
    const angle = Math.atan2(dy, dx);
    
    knob.style.transform = `translate(-50%, -50%) translate(${Math.cos(angle)*distance}px, ${Math.sin(angle)*distance}px)`;
    
    joystickVector.x = (dx / 32);
    joystickVector.y = -(dy / 32);
  });
  
  document.addEventListener('touchend', e => {
    if(touchId !== null && !Array.from(e.touches).find(t => t.identifier === touchId)) {
      joystickActive = false;
      touchId = null;
      knob.style.transform = 'translate(-50%, -50%)';
      joystickVector = {x: 0, y: 0};
    }
  });
  
  jumpBtn.addEventListener('touchstart', e => {
    e.preventDefault();
    if(playerY === 0) playerVY = 0.32;
  });
  
  saveBtn.addEventListener('touchstart', e => {
    e.preventDefault();
    if(currentGameData) saveGame(currentGameData.name);
  });
}

function populateGamePlayers() {
  const c=document.getElementById('playersInGame');
  const pls=['–¢—ã',...FRIENDS.filter(f=>f.online).slice(0,3).map(f=>f.name)];
  c.innerHTML=pls.map(p=>`<div class="player-in-game"><div class="player-dot"></div><div class="player-name-hud">${p}</div></div>`).join('');
}

function exitGame() {
  cancelAnimationFrame(animId);
  if(gameRenderer) gameRenderer.dispose();
  document.exitPointerLock();
  keys={};
  joystickActive = false;
  joystickVector = {x: 0, y: 0};
  currentGameData = null;
  document.getElementById('gameScreen').classList.remove('active');
  document.getElementById('mainMenu').classList.add('active');
}

// ===== CHAT =====
function initChat(gameName) {
  chatHistory=[
    {sender:'ProGamer_X',text:'–ö—Ä—É—Ç–æ!'},
    {sender:'–°–∏—Å—Ç–µ–º–∞',text:`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ¬´${gameName}¬ª!`},
    {sender:'StarPlayer',text:'–ì–æ –≤–º–µ—Å—Ç–µ –∏–≥—Ä–∞—Ç—å?'},
  ];
  renderChat();
}

function renderChat() {
  const box=document.getElementById('chatMessages');
  box.innerHTML=chatHistory.map(m=>`<div class="chat-msg"><span class="chat-sender">${m.sender}:</span> ${m.text}</div>`).join('');
  box.scrollTop=box.scrollHeight;
}

function sendChat() {
  const inp=document.getElementById('chatInput');
  const txt=inp.value.trim();
  if(!txt) return;
  chatHistory.push({sender:'–¢—ã',text:txt});
  inp.value='';
  renderChat();
  setTimeout(()=>{
    const replies=['–û—Ç–ª–∏—á–Ω–æ!','–°–æ–≥–ª–∞—Å–µ–Ω üëç','–ö—Ä—É—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å!','–ì–æ –µ—â—ë!','üëèüëèüëè'];
    const names=['ProGamer_X','StarPlayer','CoolDev_99'];
    chatHistory.push({sender:names[Math.floor(Math.random()*names.length)],text:replies[Math.floor(Math.random()*replies.length)]});
    renderChat();
  },1000+Math.random()*1500);
}

// ===== FRIENDS =====
function showAddFriend() {
  const n=prompt('–í–≤–µ–¥–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:');
  if(n&&n.trim()) showNotif(`‚úÖ –ó–∞–ø—Ä–æ—Å –¥—Ä—É–≥—É ¬´${n.trim()}¬ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!`);
}

// ===== RESIZE =====
window.addEventListener('resize',()=>{ resizeAvatar(); resizeStudio(); });

// Add animations
const style = document.createElement('style');
style.textContent = `
@keyframes slideIn { from{transform:translateX(-50%) translateY(-60px);opacity:0} to{transform:translateX(-50%) translateY(0);opacity:1} }
@keyframes slideOut { from{transform:translateX(-50%) translateY(0);opacity:1} to{transform:translateX(-50%) translateY(-60px);opacity:0} }
`;
document.head.appendChild(style);
</script>
</body>
</html>
